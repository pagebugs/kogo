<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>회원가입 - Kogo</title>
    <!-- 공통 스타일 -->
    <link rel="stylesheet" href="../../assets/css/common/tokens.css">
    <link rel="stylesheet" href="../../assets/css/common/base.css">
    <!-- 인증 페이지 스타일 -->
    <link rel="stylesheet" href="../../assets/css/auth/auth.css">
    <!-- SUIT Font -->
    <link href="https://cdn.jsdelivr.net/gh/sun-typeface/SUIT/fonts/variable/woff2/SUIT-Variable.css" rel="stylesheet">
</head>
<body class="auth-page">

    <div class="auth-container auth-container--wide">
        <div class="auth-card">
            <!-- Header -->
            <div class="auth-header">
                <a href="/" class="auth-logo">Kogo</a>
                <h1 class="auth-title">회원가입</h1>
                <p class="auth-subtitle">Kogo 서비스 이용을 위한 계정을 만들어 주세요</p>
            </div>

            <!-- Progress Steps -->
            <div class="signup-progress">
                <div class="progress-step active" data-step="1">
                    <div class="step-number">1</div>
                    <div class="step-label">계정 정보</div>
                </div>
                <div class="progress-line"></div>
                <div class="progress-step" data-step="2">
                    <div class="step-number">2</div>
                    <div class="step-label">추가 정보</div>
                </div>
            </div>

            <!-- =========================================================
                 Step 1: 회원유형 선택 + 계정 정보 + 약관 동의
                 ========================================================= -->
            <div class="signup-step active" id="step1">
                <h2 class="step-title">계정 정보 입력</h2>
                <p class="step-description">회원 유형을 선택하고 계정 정보를 입력해 주세요</p>

                <form class="auth-form" id="step1Form">
                    
                    <!-- 회원 유형 선택 (라디오 - 간단) -->
                    <div class="form-group">
                        <label>회원 유형 *</label>
                        <div class="member-type-simple">
                            <label class="radio-simple">
                                <input type="radio" name="memberType" value="GENERAL" checked>
                                <span>일반 회원</span>
                            </label>
                            <label class="radio-simple">
                                <input type="radio" name="memberType" value="COOP_MEMBER">
                                <span>조합 회원</span>
                            </label>
                            <label class="radio-simple">
                                <input type="radio" name="memberType" value="PARTNER">
                                <span>파트너</span>
                            </label>
                        </div>
                    </div>

                    <!-- 이메일 (ID) -->
                    <div class="form-group" id="emailGroup">
                        <label for="email">이메일 (ID) *</label>
                        <div class="input-with-action">
                            <input type="email" id="email" name="email" placeholder="example@company.com" required autocomplete="email">
                            <button type="button" class="btn-check" id="checkEmailBtn">중복확인</button>
                        </div>
                        <p class="error-message" id="emailError">올바른 이메일 형식을 입력해 주세요</p>
                        <p class="success-message" id="emailSuccess" style="display:none;">사용 가능한 이메일입니다</p>
                    </div>

                    <!-- 비밀번호 -->
                    <div class="form-group" id="passwordGroup">
                        <label for="password">비밀번호 *</label>
                        <input type="password" id="password" name="password" placeholder="8자 이상, 영문/숫자/특수문자 포함" required minlength="8">
                        <div class="password-strength">
                            <div class="password-strength-bar" id="strengthBar"></div>
                        </div>
                        <p class="password-hint" id="passwordHint">8자 이상, 영문·숫자·특수문자 조합 권장</p>
                        <p class="error-message">비밀번호 조건을 확인해 주세요</p>
                    </div>

                    <!-- 비밀번호 확인 -->
                    <div class="form-group" id="passwordConfirmGroup">
                        <label for="passwordConfirm">비밀번호 확인 *</label>
                        <input type="password" id="passwordConfirm" name="passwordConfirm" placeholder="비밀번호 재입력" required>
                        <p class="error-message">비밀번호가 일치하지 않습니다</p>
                        <p class="success-message" id="passwordMatch" style="display:none;">비밀번호가 일치합니다</p>
                    </div>

                    <!-- 약관 동의 -->
                    <div class="terms-section">
                        <label class="terms-all">
                            <input type="checkbox" id="agreeAll">
                            <span>전체 동의</span>
                        </label>
                        <div class="terms-list">
                            <label class="terms-item">
                                <input type="checkbox" id="termsService" required>
                                <span>[필수] 서비스 이용약관 동의</span>
                                <a href="/terms.html" target="_blank">보기</a>
                            </label>
                            <label class="terms-item">
                                <input type="checkbox" id="termsPrivacy" required>
                                <span>[필수] 개인정보처리방침 동의</span>
                                <a href="/privacy.html" target="_blank">보기</a>
                            </label>
                            <label class="terms-item">
                                <input type="checkbox" id="termsMarketing">
                                <span>[선택] 마케팅 정보 수신 동의</span>
                            </label>
                        </div>
                    </div>

                    <div class="form-actions">
                        <a href="index.html" class="btn-back">← 로그인으로</a>
                        <button type="submit" class="auth-btn">다음 단계 →</button>
                    </div>
                </form>
            </div>

            <!-- =========================================================
                 Step 2: 추가 정보 (이름, 연락처, 회사/조합사, 직책)
                 ========================================================= -->
            <div class="signup-step" id="step2">
                <h2 class="step-title">추가 정보 입력</h2>
                <p class="step-description">서비스 이용을 위한 기본 정보를 입력해 주세요</p>

                <form class="auth-form" id="step2Form">
                    <div class="form-group">
                        <label for="name">이름 *</label>
                        <input type="text" id="name" name="name" placeholder="홍길동" required>
                    </div>

                    <div class="form-group">
                        <label for="phone">휴대폰 번호 *</label>
                        <input type="tel" id="phone" name="phone" placeholder="010-0000-0000" required>
                    </div>

                    <div class="form-row">
                        <!-- 일반회원/파트너: 회사명 입력 -->
                        <div class="form-group" id="companyField">
                            <label for="company">회사명 <span id="companyRequired"></span></label>
                            <input type="text" id="company" name="company" placeholder="(주)회사명 또는 병원명">
                        </div>

                        <!-- 조합회원: 조합사명 선택 (조건부 표시) -->
                        <div class="form-group" id="johapField" style="display:none;">
                            <label for="johapSelect">소속 조합사 *</label>
                            <select id="johapSelect" name="johapId" required>
                                <option value="">조합사를 선택해 주세요</option>
                                <!-- johap-list.js에서 동적 로드 -->
                            </select>
                        </div>

                        <div class="form-group">
                            <label for="position">직책/직함</label>
                            <input type="text" id="position" name="position" placeholder="대표 / 마케팅 담당">
                        </div>
                    </div>

                    <div class="form-actions">
                        <button type="button" class="btn-back" id="backToStep1">← 이전</button>
                        <button type="submit" class="auth-btn auth-btn--complete">가입 완료</button>
                    </div>
                </form>
            </div>

            <!-- Footer -->
            <div class="auth-footer">
                <p>이미 계정이 있으신가요? <a href="index.html">로그인</a></p>
            </div>
        </div>
    </div>

    <!-- 조합 목록 (정적 파일) -->
    <script src="../../assets/js/auth/johap-list.js"></script>
    <script src="../../assets/js/auth/auth.js"></script>
    <script>
        // =========================================================
        // 상태 관리
        // =========================================================
        const signupData = {
            email: '',
            password: '',
            memberType: 'GENERAL',
            johapId: null,
            name: '',
            phone: '',
            company: '',
            position: ''
        };
        
        let emailVerified = false;
        let currentStep = 1;

        // =========================================================
        // 초기화: 조합 목록 로드
        // =========================================================
        document.addEventListener('DOMContentLoaded', () => {
            const johapSelect = document.getElementById('johapSelect');
            if (typeof JOHAP_LIST !== 'undefined') {
                JOHAP_LIST.forEach(johap => {
                    const opt = document.createElement('option');
                    opt.value = johap.id;
                    opt.textContent = johap.name;
                    johapSelect.appendChild(opt);
                });
            }
        });

        // =========================================================
        // Step 네비게이션
        // =========================================================
        function goToStep(step) {
            document.querySelectorAll('.signup-step').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.progress-step').forEach(el => el.classList.remove('active', 'completed'));
            
            document.getElementById(`step${step}`).classList.add('active');
            
            for (let i = 1; i <= step; i++) {
                const stepEl = document.querySelector(`.progress-step[data-step="${i}"]`);
                if (i < step) {
                    stepEl.classList.add('completed');
                } else if (i === step) {
                    stepEl.classList.add('active');
                }
            }
            
            currentStep = step;

            // Step 2 진입 시 회원유형에 따라 필드 조정
            if (step === 2) {
                updateStep2Fields();
            }
        }

        // Step 2 필드 업데이트 (회원유형에 따라)
        function updateStep2Fields() {
            const companyField = document.getElementById('companyField');
            const johapField = document.getElementById('johapField');
            const companyRequired = document.getElementById('companyRequired');
            const companyInput = document.getElementById('company');

            if (signupData.memberType === 'COOP_MEMBER') {
                // 조합회원: 조합사 선택 표시, 회사명 숨김
                companyField.style.display = 'none';
                johapField.style.display = 'block';
                companyInput.required = false;
            } else if (signupData.memberType === 'PARTNER') {
                // 파트너: 회사명 필수
                companyField.style.display = 'block';
                johapField.style.display = 'none';
                companyRequired.textContent = '*';
                companyInput.required = true;
            } else {
                // 일반회원: 회사명 선택
                companyField.style.display = 'block';
                johapField.style.display = 'none';
                companyRequired.textContent = '';
                companyInput.required = false;
            }
        }

        // =========================================================
        // 회원 유형 선택
        // =========================================================
        document.querySelectorAll('input[name="memberType"]').forEach(radio => {
            radio.addEventListener('change', (e) => {
                signupData.memberType = e.target.value;
            });
        });

        // =========================================================
        // 이메일 중복 확인
        // =========================================================
        document.getElementById('checkEmailBtn').addEventListener('click', async () => {
            const email = document.getElementById('email').value.trim();
            const emailGroup = document.getElementById('emailGroup');
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            
            if (!emailRegex.test(email)) {
                emailGroup.classList.add('error');
                document.getElementById('emailError').textContent = '올바른 이메일 형식을 입력해 주세요';
                document.getElementById('emailSuccess').style.display = 'none';
                return;
            }
            
            try {
                const result = await AuthAPI.checkEmailExists(email);
                
                if (result.exists) {
                    emailGroup.classList.add('error');
                    document.getElementById('emailError').textContent = '이미 사용 중인 이메일입니다';
                    document.getElementById('emailSuccess').style.display = 'none';
                    emailVerified = false;
                } else {
                    emailGroup.classList.remove('error');
                    document.getElementById('emailSuccess').style.display = 'block';
                    emailVerified = true;
                    signupData.email = email;
                }
            } catch (err) {
                // API 미구현 시 임시 통과
                emailGroup.classList.remove('error');
                document.getElementById('emailSuccess').style.display = 'block';
                emailVerified = true;
                signupData.email = email;
            }
        });

        // =========================================================
        // 비밀번호 강도 체크
        // =========================================================
        document.getElementById('password').addEventListener('input', (e) => {
            const password = e.target.value;
            const bar = document.getElementById('strengthBar');
            const hint = document.getElementById('passwordHint');
            
            const strength = checkPasswordStrength(password);
            bar.className = 'password-strength-bar ' + strength.level;
            hint.textContent = strength.message;
        });

        function checkPasswordStrength(password) {
            if (password.length < 6) return { level: 'weak', message: '비밀번호가 너무 짧습니다' };
            if (password.length < 8) return { level: 'medium', message: '8자 이상 입력해 주세요' };
            
            const hasLetter = /[a-zA-Z]/.test(password);
            const hasNumber = /[0-9]/.test(password);
            const hasSpecial = /[!@#$%^&*(),.?":{}|<>]/.test(password);
            
            if (password.length >= 10 && hasLetter && hasNumber && hasSpecial) {
                return { level: 'strong', message: '안전한 비밀번호입니다' };
            }
            if (hasLetter && hasNumber) {
                return { level: 'medium', message: '특수문자를 추가하면 더 안전합니다' };
            }
            return { level: 'weak', message: '영문, 숫자, 특수문자를 조합해 주세요' };
        }

        // =========================================================
        // 비밀번호 확인
        // =========================================================
        document.getElementById('passwordConfirm').addEventListener('input', (e) => {
            const password = document.getElementById('password').value;
            const confirm = e.target.value;
            const group = document.getElementById('passwordConfirmGroup');
            const matchMsg = document.getElementById('passwordMatch');
            
            if (confirm && password === confirm) {
                group.classList.remove('error');
                matchMsg.style.display = 'block';
            } else if (confirm) {
                group.classList.add('error');
                matchMsg.style.display = 'none';
            }
        });

        // =========================================================
        // 전체 동의
        // =========================================================
        document.getElementById('agreeAll').addEventListener('change', (e) => {
            const checked = e.target.checked;
            document.querySelectorAll('.terms-list input[type="checkbox"]').forEach(cb => {
                cb.checked = checked;
            });
        });

        // =========================================================
        // Step 1 폼 제출
        // =========================================================
        document.getElementById('step1Form').addEventListener('submit', (e) => {
            e.preventDefault();
            
            const password = document.getElementById('password').value;
            const passwordConfirm = document.getElementById('passwordConfirm').value;
            
            // 이메일 중복 확인 체크
            if (!emailVerified) {
                alert('이메일 중복 확인을 해주세요');
                return;
            }
            
            // 비밀번호 검증
            if (password.length < 8) {
                document.getElementById('passwordGroup').classList.add('error');
                return;
            }
            
            if (password !== passwordConfirm) {
                document.getElementById('passwordConfirmGroup').classList.add('error');
                return;
            }
            
            // 필수 약관 체크
            if (!document.getElementById('termsService').checked || 
                !document.getElementById('termsPrivacy').checked) {
                alert('필수 약관에 동의해 주세요');
                return;
            }
            
            signupData.password = password;
            goToStep(2);
        });

        // =========================================================
        // Step 2: 추가 정보
        // =========================================================
        document.getElementById('backToStep1').addEventListener('click', () => goToStep(1));

        document.getElementById('step2Form').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            signupData.name = document.getElementById('name').value.trim();
            signupData.phone = document.getElementById('phone').value.trim();
            signupData.position = document.getElementById('position').value.trim();
            
            if (!signupData.name || !signupData.phone) {
                alert('이름과 연락처는 필수입니다');
                return;
            }

            // 회원유형별 추가 검증
            if (signupData.memberType === 'COOP_MEMBER') {
                signupData.johapId = document.getElementById('johapSelect').value;
                if (!signupData.johapId) {
                    alert('소속 조합사를 선택해 주세요');
                    return;
                }
                signupData.company = ''; // 조합원은 회사명 대신 조합사
            } else {
                signupData.company = document.getElementById('company').value.trim();
                signupData.johapId = null;
                
                if (signupData.memberType === 'PARTNER' && !signupData.company) {
                    alert('파트너 회원은 회사명이 필수입니다');
                    return;
                }
            }
            
            const btn = e.target.querySelector('.auth-btn--complete');
            btn.disabled = true;
            btn.textContent = '가입 처리 중...';
            
            try {
                const result = await AuthAPI.signup(signupData);
                
                if (result.success) {
                    const msg = signupData.memberType !== 'GENERAL' 
                        ? '회원가입이 완료되었습니다!\n관리자 승인 후 전체 기능을 이용하실 수 있습니다.' 
                        : '회원가입이 완료되었습니다!';
                    alert(msg);
                    window.location.href = 'index.html?signup=success';
                }
            } catch (err) {
                alert('회원가입 실패: ' + err.message);
            } finally {
                btn.disabled = false;
                btn.textContent = '가입 완료';
            }
        });
    </script>
</body>
</html>
