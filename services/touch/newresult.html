<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>í„°ì¹˜ì• ë“œ - ì‹œì¥ ë¶„ì„ ì¸ì‚¬ì´íŠ¸</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/sun-typeface/SUIT/fonts/variable/woff2/SUIT-Variable.css">
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
  <link rel="stylesheet" href="../../assets/css/common/tokens.css">
  <link rel="stylesheet" href="../../assets/css/common/base.css">
  <link rel="stylesheet" href="../../assets/css/style.css">
  <link rel="stylesheet" href="../../assets/css/insight.css">
  <link rel="stylesheet" href="../../assets/css/gnb.css">
  <link rel="stylesheet" href="../../assets/css/inquiry.css">
  <!-- Chart.js ìœ ì§€ (ì¶”í›„ ë³µì›ìš©) -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <!-- CONFIG JS (API Key ë“±) -->
  <script src="../../assets/js/config.js"></script>
</head>
<body class="has-gnb">

<!-- =========================================================
<!-- HEADER (Loaded Dynamically) -->
<div id="include-header"></div>

  <div class="container dashboard-container">
    
    <!-- =========================================================
         STAGE 1: Immediate Numeric Impact (ìˆ«ìë¡œ ì§ê´€ì„ ê¹¨ëŠ” êµ¬ê°„)
         ëª©ì : "Ah-ha" Moment - ì •ì§€ íš¨ê³¼ ìœ ë°œ
    ========================================================= -->
    <section class="stage-kpi-hero">
      <div class="kpi-hero-header">
        <span class="hospital-badge" id="hospitalName">ë³‘ì›ëª…</span>
        <span class="kpi-time-context">ì§€ë‚œ 4ì£¼ê°„ Â· <span id="currentDate">2026.01.28</span> ê¸°ì¤€</span>
      </div>

      <div class="kpi-hero-row">
        <!-- KPI 1: Primary - ì ì¬ í™˜ì ìˆ˜ (ì§ˆë¬¸í˜• ì¹´í”¼) -->
        <div class="kpi-hero-card primary">
          <div class="kpi-question">ì´ ìˆ«ìê°€ ì›ì¥ë‹˜ê»˜<br>ë¬´ìŠ¨ ì˜ë¯¸ì¼ê¹Œìš”?</div>
          <div class="kpi-hero-value-group">
            <span class="kpi-hero-value" id="val-scale">0</span>
            <span class="kpi-hero-unit">ëª…</span>
          </div>
          <div class="kpi-hero-subtext">ë¶ˆíŠ¹ì • ë…¸ì¶œì„ ì œì™¸í•œ <strong>ì‹¤ì œ ë‚´ì› ê°€ëŠ¥ì„± ê¸°ì¤€</strong> ìˆ˜ì¹˜ì…ë‹ˆë‹¤</div>
        </div>

        <!-- KPI 2: 30ëŒ€ í•µì‹¬ì¸µ -->
        <div class="kpi-hero-card">
          <div class="kpi-question">ì„±í˜•Â·í”¼ë¶€ ì‹œìˆ <br>ìµœë‹¤ ì†Œë¹„ ì—°ë ¹ëŒ€</div>
          <div class="kpi-hero-value-group">
            <span class="kpi-hero-value" id="val-precision">0</span>
            <span class="kpi-hero-unit">%</span>
          </div>
          <div class="kpi-hero-subtext">30ëŒ€ í•µì‹¬ì¸µ ë¹„ì¤‘</div>
        </div>

        <!-- KPI 3: ì—¬ì„± ê³ ê° -->
        <div class="kpi-hero-card">
          <div class="kpi-question">ë·°í‹°Â·ê±´ê°• ì†Œë¹„ë¥¼<br>ì£¼ë„í•˜ëŠ” ë¹„ì¤‘</div>
          <div class="kpi-hero-value-group">
            <span class="kpi-hero-value" id="val-relevance">0</span>
            <span class="kpi-hero-unit">%</span>
          </div>
          <div class="kpi-hero-subtext">ì—¬ì„± ê³ ê° ì ìœ ìœ¨</div>
        </div>
      </div>

      <!-- Data Source Note (KPI ì£¼ì„ ë ˆë²¨) -->
      <div class="kpi-source-note">
        <span class="kpi-source-badge">ë¶„ì„ ê¸°ì¤€</span>
        <span id="kpiSourceContext">ë³‘ì› ì£¼ì†Œ ê¸°ì¤€ ë°˜ê²½ 700m Â· 30ëŒ€ ì—¬ì„±</span>
      </div>
    </section>

    <!-- =========================================================
         STAGE 2: Situation Framing (ìƒí™© ê·œì •) - ì¶”í›„ ë¡œì§ ê°œë°œ í•„ìš”
         ëª©ì : 'ìˆ«ìë¥¼ ê·¸ëƒ¥ ë‘ë©´ ì•ˆ ë˜ëŠ” ìƒíƒœ'ë¡œ ê·œì •
         â€» ê³ ì • ë¬¸ì¥ ì˜ì—­ - í•´ì„¤ âŒ / ìƒí™© íŒê²° âœ…
    ========================================================= -->
    <section class="stage-situation">
      <div class="situation-card">
        <!-- ë¬¸ì¥ â‘  ìƒíƒœ ê·œì • (Fact â†’ Situation) -->
        <p class="situation-line situation-state">
          í˜„ì¬ ì´ ì§„ë£Œê¶Œì€<br>
          <strong>ê³ ê´€ì—¬ ì†Œë¹„ê°€ í™œë°œí•˜ì§€ë§Œ, ì„ íƒì´ ê³ ì •ë˜ì§€ ì•Šì€ êµ¬ì¡°</strong>ì…ë‹ˆë‹¤.
        </p>
        
        <!-- ë¬¸ì¥ â‘¡ ë°©ì¹˜ ì‹œ ê²°ê³¼ (Silent Risk) -->
        <p class="situation-line situation-risk">
          ì´ ìƒíƒœì—ì„œëŠ”<br>
          <strong>ë¨¼ì € ë…¸ì¶œë˜ëŠ” ë³‘ì›ì´ ê¸°ì¤€ì </strong>ì´ ë©ë‹ˆë‹¤.
        </p>
        
        <!-- ë¬¸ì¥ â‘¢ ì‚¬ìš©ì ì—°ê²° (Implicit You) -->
        <p class="situation-line situation-opportunity">
          ì•„ì§ ê¸°ì¤€ì ì´ ì •í•´ì§€ì§€ ì•Šì•˜ë‹¤ëŠ” ê²ƒì€,<br>
          <strong>ì§€ê¸ˆ íŒë‹¨ì´ êµ¬ì¡°ë¥¼ ë°”ê¿€ ìˆ˜ ìˆë‹¤</strong>ëŠ” ì˜ë¯¸ì´ê¸°ë„ í•©ë‹ˆë‹¤.
        </p>
      </div>
    </section>

    <!-- =========================================================
         STAGE 3: Spatial Evidence (ê³µê°„ì  ì‹¤ì¬ê°)
         ëª©ì : Mapì€ 'í™•ì¸ìš© UI'ê°€ ì•„ë‹ˆë¼ 'ì¦ê±°ë¬¼'
    ========================================================= -->
    <section class="stage-map-evidence">
      <div class="map-evidence-header">
        <h2 class="map-evidence-title">ì§„ë£Œê¶Œ ì§€ë„</h2>
        <p class="map-evidence-desc">
          <strong>â€» ì‹¤ì œ ê²°ì œÂ·ì´ë™ ë°ì´í„° ê¸°ë°˜</strong>
        </p>
      </div>
      <div class="map-section-full" id="view-map">
        <div id="kakaoMap"></div>
      </div>
    </section>

    <!-- =========================================================
         STAGE 4: GPT Insight (AI ì „ëµ ì¸ì‚¬ì´íŠ¸)
         ëª©ì : í–‰ë™ ì „í™˜ì„ ìœ ë„í•˜ëŠ” í•´ì„
         â€» ëŒ€í™”í˜• ë‹¨ì¼ ë°•ìŠ¤ - GPT ì¶œë ¥ì„ ê·¸ëŒ€ë¡œ ë Œë”ë§
    ========================================================= -->
    <section class="stage-gpt-insight" id="gptInsightSection">
      <div class="gpt-insight-card">
        <div class="gpt-insight-header">
          <span class="gpt-insight-icon">ğŸ¤–</span>
          <h3 class="gpt-insight-title">AI ì „ëµ ì¸ì‚¬ì´íŠ¸</h3>
        </div>
        <div class="gpt-insight-content" id="gptInsightContent">
          <p class="gpt-insight-text">ë¶„ì„ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤...</p>
        </div>
      </div>
    </section>

    <!-- =========================================================
        STAGE 5: Single CTA (Low-friction Action)
        ëª©ì : "êµ¬ë§¤"ê°€ ì•„ë‹ˆë¼ "ì´í•´ ìš”ì²­"
    ========================================================= -->
    <section class="stage-single-cta">
      <div class="single-cta-card">
        <p class="single-cta-message">
          ì´ ë°ì´í„°ê°€ ìš°ë¦¬ ë³‘ì›ì— ì–´ë–¤ ì˜ë¯¸ì¸ì§€,<br>
          ë‹´ë‹¹ìê°€ <strong>ë§ì¶¤ í•´ì„</strong>ì„ ë„ì™€ë“œë¦½ë‹ˆë‹¤.
        </p>
        <button type="button" class="single-cta-btn" id="openInquiryBtn">
          ì´ ë°ì´í„°ê°€ ì˜ë¯¸í•˜ëŠ” ë°”ë¥¼ ì„¤ëª…í•´ ì£¼ì„¸ìš”
        </button>
        <p class="single-cta-note">
          ì„¤ëª… ìš”ì²­ í›„ 24ì‹œê°„ ë‚´ ë‹´ë‹¹ìê°€ ì—°ë½ë“œë¦½ë‹ˆë‹¤.
        </p>
      </div>
    </section>

    <!-- =========================================================
         STAGE 6: Single CTA (Low-friction Action)
         ëª©ì : êµ¬ì²´ì  ìˆ«ìë¡œ í–‰ë™ ë¹„ìš©ì„ ë‚®ì¶”ëŠ” ì—­í• 
    ========================================================= 
    <section class="stage-single-cta">
      <div class="single-cta-card">

        <p class="single-cta-message">
          ë¹„ìŠ·í•œ íŠ¹ì„±ì˜ ê³ ê° <strong id="ctaTargetCount">6,044</strong>ëª…ì—ê²Œ ë„ë‹¬í•˜ê¸° ìœ„í•œ<br>
          <strong>ë§ì¶¤ ì˜ˆì‚°ì•ˆ</strong>ì„ ë°›ì•„ë³´ì„¸ìš”.
        </p>

        <button type="button" class="single-cta-btn" id="openInquiryBtn">
          ìš°ë¦¬ ë³‘ì› ë§ì¶¤ ì˜ˆì‚°ì•ˆ ë°›ì•„ë³´ê¸°
        </button>

        <p class="single-cta-note">
          í‰ê·  <strong>5%</strong> ìˆ˜ì¤€ì˜ ê³ ê° ì „í™˜ ê¸°ëŒ€ Â· 24ì‹œê°„ ë‚´ ë‹´ë‹¹ì ì—°ë½
        </p>
        ë¹„ìš© ë¹„êµ (Beta ë²¤ì¹˜ë§ˆí‚¹) 
        <div class="cta-cost-comparison">
          <div class="cost-item cost-touchad">
            <span class="cost-label">í„°ì¹˜ì• ë“œ ì˜ˆìƒ ë¹„ìš©</span>
            <span class="cost-value" id="ctaCostTouchad">ì•½ <strong>363</strong>ì›</span>
            <span class="cost-period">30ì¼ ê¸°ì¤€</span>
          </div>
          <div class="cost-divider">
            <span class="cost-vs">VS</span>
          </div>
          <div class="cost-item cost-naver">
            <span class="cost-label">ë„¤ì´ë²„ í‚¤ì›Œë“œ ê´‘ê³ </span>
            <span class="cost-value cost-strikethrough" id="ctaCostNaver">ì•½ 6,044,000ì›</span>
            <span class="cost-badge">99% ì ˆê°</span>
          </div>
        </div>
      </div>
    </section> -->

    <!-- =========================================================
         FOOTER (Loaded Dynamically)
    ========================================================= -->
    <div id="include-footer"></div>

  </div>

  <!-- Common Scripts -->
  <script src="../../assets/js/gnb.js"></script>
  <script src="../../assets/js/ui-loader.js"></script>

  <!-- =========================================================
       Contextual Inquiry Modal
       âš ï¸ This is NOT a CS ticket. It captures where user understanding stopped.
  ========================================================= -->
  <div id="inquiryModal" class="inquiry-modal" style="display:none;">
    <div class="inquiry-modal-backdrop"></div>
    <div class="inquiry-modal-content">
      <div class="inquiry-modal-header">
        <h2>ì´ ë°ì´í„°ì— ëŒ€í•´ ì„¤ëª…ì´ í•„ìš”í•˜ì‹ ê°€ìš”?</h2>
        <button type="button" class="inquiry-modal-close" id="closeInquiryBtn">&times;</button>
      </div>
      
      <div class="inquiry-context-badge">
        <span class="context-icon">ğŸ“Š</span>
        <span id="inquiryContextLabel">í˜„ì¬ ë¶„ì„ ê²°ê³¼ë¥¼ ê¸°ì¤€ìœ¼ë¡œ ë‹´ë‹¹ìê°€ ì•ˆë‚´í•´ ë“œë¦½ë‹ˆë‹¤</span>
      </div>
      
      <form id="inquiryForm">
        <!-- Contact Info -->
        <div class="inquiry-form-group">
          <label for="contactPhone">ì—°ë½ë°›ìœ¼ì‹¤ ì „í™”ë²ˆí˜¸ <span class="required">*</span></label>
          <input type="tel" id="contactPhone" name="phone" placeholder="ì˜ˆ: 010-0000-0000" required>
        </div>

        <div class="inquiry-form-group">
          <label for="contactEmail">ì´ë©”ì¼ (ì„ íƒ)</label>
          <input type="email" id="contactEmail" name="email" placeholder="result@example.com">
        </div>

        <!-- Interest Tags -->
        <div class="inquiry-form-group">
          <label>ì£¼ìš” ê¶ê¸ˆí•œ ì  (ì¤‘ë³µ ì„ íƒ ê°€ëŠ¥)</label>
          <div class="inquiry-checkbox-group">
            <label class="inquiry-checkbox">
              <input type="checkbox" name="interest" value="data_interpretation">
              <span class="checkmark"></span>
              ì´ ë°ì´í„°ê°€ ìš°ë¦¬ ë³‘ì›ì— ì–´ë–¤ ì˜ë¯¸ì¸ì§€
            </label>
            <label class="inquiry-checkbox">
              <input type="checkbox" name="interest" value="execution_feasibility">
              <span class="checkmark"></span>
              ì‹¤ì œ ê´‘ê³  ì§‘í–‰ ê°€ëŠ¥ì„±ê³¼ ì ˆì°¨
            </label>
            <label class="inquiry-checkbox">
              <input type="checkbox" name="interest" value="cost_structure">
              <span class="checkmark"></span>
              ì˜ˆìƒ ë¹„ìš© ë° ê³¼ê¸ˆ êµ¬ì¡°
            </label>
            <label class="inquiry-checkbox">
              <input type="checkbox" name="interest" value="custom_strategy">
              <span class="checkmark"></span>
              ìš°ë¦¬ ë³‘ì›ì— ë§ëŠ” íƒ€ê²ŸíŒ… ì „ëµ
            </label>
          </div>
        </div>

        <!-- Additional Content (Textarea) -->
        <div class="inquiry-form-group">
          <label for="inquiryContent">ê¸°íƒ€ ë¬¸ì˜ ë‚´ìš© (ì„ íƒ)</label>
          <textarea id="inquiryContent" name="content" rows="3" placeholder="ì¶”ê°€ë¡œ ê¶ê¸ˆí•˜ì‹  ì ì„ ììœ ë¡­ê²Œ ì ì–´ì£¼ì„¸ìš”."></textarea>
        </div>
        
        <p class="inquiry-notice">
          ë‚¨ê²¨ì£¼ì‹  ì •ë³´ëŠ” ìƒë‹´ ëª©ì ìœ¼ë¡œë§Œ í™œìš©ë˜ë©°, <br>
          ë‹´ë‹¹ìê°€ ë¶„ì„ ë°ì´í„°ë¥¼ ë¯¸ë¦¬ í™•ì¸ í›„ ì—°ë½ë“œë¦½ë‹ˆë‹¤.
        </p>
        
        <div class="inquiry-form-actions">
          <button type="button" class="inquiry-btn-secondary" id="cancelInquiryBtn">ì·¨ì†Œ</button>
          <button type="submit" class="inquiry-btn-primary">ì„¤ëª… ìš”ì²­í•˜ê¸°</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Inquiry Success Modal -->
  <div id="inquirySuccessModal" class="inquiry-modal" style="display:none;">
    <div class="inquiry-modal-backdrop"></div>
    <div class="inquiry-modal-content inquiry-success-content">
      <div class="inquiry-success-icon">âœ“</div>
      <h2>ì„¤ëª… ìš”ì²­ì´ ì ‘ìˆ˜ë˜ì—ˆìŠµë‹ˆë‹¤</h2>
      <p class="inquiry-success-desc">
        í˜„ì¬ ë³´ê³  ê³„ì‹  ë¶„ì„ ê²°ê³¼ë¥¼ ê¸°ì¤€ìœ¼ë¡œ <br>
        ë‹´ë‹¹ìê°€ ê²€í†  í›„ ë¹ ë¥´ê²Œ ì—°ë½ë“œë¦¬ê² ìŠµë‹ˆë‹¤.<br>
        <br>
        <span style="font-size: 0.9em; color: #888;">ì ‘ìˆ˜ ë²ˆí˜¸: <span id="inquirySuccessId"></span></span>
      </p>
      
      <!-- ì¡°ê±´ë¶€ Order ì „í™˜ CTA (ì¡°ê±´ ì¶©ì¡± ì‹œì—ë§Œ í‘œì‹œ) -->
      <div id="orderCtaSection" class="order-cta-section" style="display:none;">
        <p class="order-cta-message">
          ì´ ë¶„ì„ ê²°ê³¼ë¥¼ ê¸°ì¤€ìœ¼ë¡œ<br>
          <strong>ì‹¤ì œ ì§‘í–‰ ê°€ëŠ¥ì„±ì— ëŒ€í•œ ì„¤ëª…</strong>ì„ ë°›ì•„ë³¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤.
        </p>
        <button type="button" class="inquiry-btn-primary" id="orderNextStepBtn">ë‹¤ìŒ ë‹¨ê³„ ì„¤ëª… ë³´ê¸°</button>
      </div>
      
      <button type="button" class="inquiry-btn-secondary" id="closeSuccessBtn">ë‹«ê¸°</button>
    </div>
  </div>

  <!-- Hidden Chart Canvas (ì¶”í›„ ë³µì›ìš©) -->
  <div style="display:none;">
    <canvas id="mainChart"></canvas>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
      // -------------------------------------------------------
      // 1. Data Loading & Initialization
      // -------------------------------------------------------
      const storedData = localStorage.getItem('touchadData');
      
      // Fallback for direct access without data (Dev Mode)
      const defaultData = {
        hospitalName: "ì²´í—˜ ë³‘ì›",
        resData: [
          { target: 12500 }, // Total
          { target: 4500 },  // 30s
          { target: 8200 }   // Female
        ]
      };

      const data = storedData ? JSON.parse(storedData) : defaultData;
      
      let baseTotal = 0;
      let baseAge = 0;
      let baseGender = 0;

      if (data.dunjugoValues && data.dunjugoValues.length > 0) {
          baseTotal = data.dunjugoValues[0]?.value || 12500;
          baseAge = data.dunjugoValues[1]?.value || 4500;
          baseGender = data.dunjugoValues[2]?.value || 8200;
      } else if (data.resData && data.resData.length > 0) {
           baseTotal = data.resData[0]?.dunjugo || data.resData[0]?.target || 12500;
           baseAge = data.resData[1]?.dunjugo || data.resData[1]?.target || 4500;
           baseGender = data.resData[2]?.dunjugo || data.resData[2]?.target || 8200;
      } else {
           baseTotal = 12500;
           baseAge = 4500;
           baseGender = 8200;
      }

      // UI References
      const elHospitalName = document.getElementById('hospitalName');
      const elDate = document.getElementById('currentDate');
      
      // KPIs
      const elValScale = document.getElementById('val-scale');
      const elValPrecision = document.getElementById('val-precision');
      const elValRelevance = document.getElementById('val-relevance');
      
      // Interpretation
      const elInterpTotal = document.getElementById('interp-total');
      const elInterpAgePct = document.getElementById('interp-age-pct');
      const elInterpGenderPct = document.getElementById('interp-gender-pct');

      // Set Metadata
      elHospitalName.textContent = data.hospitalName || "ì²´í—˜ ë³‘ì›";
      const today = new Date();
      elDate.textContent = `${today.getFullYear()}.${String(today.getMonth()+1).padStart(2, '0')}.${String(today.getDate()).padStart(2, '0')}`;

      // Set KPI Source Context (ë¶„ì„ ê¸°ì¤€ í‘œì‹œ)
      const elKpiSourceContext = document.getElementById('kpiSourceContext');
      if (elKpiSourceContext) {
        const storedAddress = localStorage.getItem('address-base');
        const radius = data.generalData?.radius || '700m';
        const addressShort = storedAddress ? storedAddress.split(' ').slice(0, 3).join(' ') : 'ë³‘ì› ì£¼ì†Œ';
        elKpiSourceContext.textContent = `${addressShort} ê¸°ì¤€ ë°˜ê²½ ${radius} Â· 30ëŒ€ ì—¬ì„±`;
      }

      // Map & Heatmap
      let map = null;
      let isMapLoaded = false;
      const GANGNAM_COORDS = { lat: 37.517316, lng: 127.047466 }; 

      // -------------------------------------------------------
      // 2. Logic & Rendering
      // -------------------------------------------------------
      
      // Chart ì´ˆê¸°í™” (ìˆ¨ê¹€ ìƒíƒœì§€ë§Œ ì¶”í›„ ë³µì›ìš©ìœ¼ë¡œ ìœ ì§€)
      let chartInstance = null;
      const chartCanvas = document.getElementById('mainChart');
      if (chartCanvas) {
        const ctx = chartCanvas.getContext('2d');
        Chart.defaults.font.family = 'SUIT';
        Chart.defaults.color = '#666';
        chartInstance = new Chart(ctx, {
          type: 'bar',
          data: {
            labels: ['ì ì¬ í™˜ì', 'ì—¬ì„± ê³ ê°', '30ëŒ€ íƒ€ê²Ÿ'],
            datasets: [{
              label: 'ìœ ì € ìˆ˜',
              data: [0, 0, 0],
              backgroundColor: [
                'rgba(0, 0, 0, 0.8)',
                'rgba(100, 100, 100, 0.6)',
                'rgba(200, 200, 200, 0.4)'
              ],
              borderWidth: 0,
              borderRadius: 4,
              barPercentage: 0.6
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: { legend: { display: false } }
          }
        });
      }

      function updateDashboard() {
        const multiplier = 1.0;

        const currentTotal = Math.round(baseTotal * multiplier);
        const currentGender = Math.round(baseGender * multiplier); 
        const currentAge = Math.round(baseAge * multiplier);       

        // Update KPIs with animation
        animateValue(elValScale, parseInt(elValScale.textContent.replace(/,/g, '') || 0), currentTotal, 500);
        
        // Percentages
        const precision = currentTotal > 0 ? ((currentAge / currentTotal) * 100).toFixed(1) : 0;
        elValPrecision.textContent = precision;

        const relevance = currentTotal > 0 ? ((currentGender / currentTotal) * 100).toFixed(1) : 0;
        elValRelevance.textContent = relevance;
        
        // Update Interpretation Section
        if (elInterpTotal) elInterpTotal.textContent = currentTotal.toLocaleString();
        if (elInterpAgePct) elInterpAgePct.textContent = precision;
        if (elInterpGenderPct) elInterpGenderPct.textContent = relevance;

        // Update Chart (hidden but maintained)
        if (chartInstance) {
          chartInstance.data.datasets[0].data = [currentTotal, currentGender, currentAge];
          chartInstance.update();
        }
      }

      function animateValue(obj, start, end, duration) {
        if (!obj) return;
        let startTimestamp = null;
        const step = (timestamp) => {
          if (!startTimestamp) startTimestamp = timestamp;
          const progress = Math.min((timestamp - startTimestamp) / duration, 1);
          const value = Math.floor(progress * (end - start) + start);
          obj.textContent = value.toLocaleString();
          if (progress < 1) {
            window.requestAnimationFrame(step);
          }
        };
        window.requestAnimationFrame(step);
      }

      // -------------------------------------------------------
      // 3. Map Implementation
      // -------------------------------------------------------
      function loadKakaoMap() {
        if (typeof TOUCH_CONFIG === 'undefined' || !TOUCH_CONFIG.KAKAO_API_KEY) {
          showMapError("ì§€ë„ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
          return;
        }

        const script = document.createElement("script");
        script.src = `https://dapi.kakao.com/v2/maps/sdk.js?appkey=${TOUCH_CONFIG.KAKAO_API_KEY}&libraries=services&autoload=false`;
        
        script.onload = () => {
          kakao.maps.load(() => {
            initMap();
          });
        };
        
        script.onerror = () => {
          showMapError("ì§€ë„ ì—°ê²°ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
        };

        document.head.appendChild(script);
      }

      function showMapError(msg) {
        const container = document.getElementById('kakaoMap');
        if (container) {
          container.innerHTML = `
            <div style="display:flex; flex-direction:column; justify-content:center; align-items:center; height:100%; background:#f5f5f5; color:#999; text-align:center;">
              <div style="font-size:24px; margin-bottom:10px;">âš ï¸</div>
              <div style="font-size:14px; font-weight:500;">${msg}</div>
            </div>
          `;
        }
      }

      function initMap() {
        const container = document.getElementById('kakaoMap');
        const options = {
          center: new kakao.maps.LatLng(GANGNAM_COORDS.lat, GANGNAM_COORDS.lng),
          level: 4
        };

        map = new kakao.maps.Map(container, options);
        isMapLoaded = true;

        const storedAddress = localStorage.getItem('address-base');
        
        if (storedAddress) {
          const geocoder = new kakao.maps.services.Geocoder();
          geocoder.addressSearch(storedAddress, function(result, status) {
            if (status === kakao.maps.services.Status.OK) {
              const coords = new kakao.maps.LatLng(result[0].y, result[0].x);
              map.setCenter(coords);
              
              new kakao.maps.Marker({
                map: map,
                position: coords
              });
            }
          });
        } else {
             new kakao.maps.Marker({
                map: map,
                position: new kakao.maps.LatLng(GANGNAM_COORDS.lat, GANGNAM_COORDS.lng)
              });
        }
      }

      // -------------------------------------------------------
      // 4. GPT Insight Rendering (ëŒ€í™”í˜• ë‹¨ì¼ ë°•ìŠ¤)
      // -------------------------------------------------------
      /**
       * âš ï¸ PROMPT ENGINEERING GUIDE (ì¶”í›„ API ì—°ë™ ì‹œ ì°¸ê³ )
       * â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
       * GPT API í˜¸ì¶œ ì‹œ ì•„ë˜ í”„ë¡¬í”„íŠ¸ êµ¬ì¡°ë¥¼ ê¶Œì¥í•©ë‹ˆë‹¤.
       * 
       * [ì‹œìŠ¤í…œ í”„ë¡¬í”„íŠ¸]
       * ë‹¹ì‹ ì€ ë³‘ì› ë§ˆì¼€íŒ… ì „ë¬¸ ì»¨ì„¤í„´íŠ¸ì…ë‹ˆë‹¤.
       * ë°ì´í„°ë¥¼ ë¶„ì„í•˜ê³ , ì˜ì‚¬ê²°ì •ì„ ìœ ë„í•˜ëŠ” ì¸ì‚¬ì´íŠ¸ë¥¼ ì œê³µí•˜ì„¸ìš”.
       * 
       * [ê·œì¹™]
       * 1. "í–‰ë™ì„ ë¯¸ë£¨ê¸° ì–´ë ¤ìš´ ìƒí™©"ì„ ì„¤ëª…í•˜ì„¸ìš” (ê´‘ê³  ê¶Œìœ  âŒ)
       * 2. 3ë‹¨ êµ¬ì¡°ë¡œ ì‘ë‹µí•˜ì„¸ìš”:
       *    - í˜„ì¬ ìƒíƒœ í•œ ë¬¸ì¥ ì§„ë‹¨
       *    - ë°©ì¹˜ ì‹œ ì˜ˆìƒ ê²°ê³¼
       *    - ì§€ê¸ˆ ê³ ë ¤í•´ë³¼ ë°©í–¥
       * 3. ì´ 3~4ë¬¸ì¥, 150ì ì´ë‚´ë¡œ ì‘ì„±í•˜ì„¸ìš”
       * 4. ëŒ€í™”ì²´ë¡œ ì‘ì„±í•˜ë˜, ê³¼ë„í•œ ì¡°ì–¸ í†¤ì€ í”¼í•˜ì„¸ìš”
       * 
       * [ì‚¬ìš©ì í”„ë¡¬í”„íŠ¸ í…œí”Œë¦¿]
       * ë‹¤ìŒ ë°ì´í„°ë¥¼ ê¸°ë°˜ìœ¼ë¡œ ì¸ì‚¬ì´íŠ¸ë¥¼ ì œê³µí•˜ì„¸ìš”:
       * - ì§„ë£Œê¶Œ ë‚´ ê°€ë§ í™˜ì: {total}ëª…
       * - 30ëŒ€ ë¹„ì¤‘: {age_pct}%
       * - ì—¬ì„± ë¹„ì¤‘: {gender_pct}%
       * - ë¶„ì„ ê¸°ì¤€: {address} ë°˜ê²½ {radius}
       * â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
       */
      function renderGptInsight() {
        const insightSection = document.getElementById('gptInsightSection');
        const insightContent = document.getElementById('gptInsightContent');
        
        if (!insightSection || !insightContent) return;

        const storedData = localStorage.getItem('touchadData');
        if (!storedData) {
          renderDefaultInsight();
          return;
        }

        try {
          const data = JSON.parse(storedData);
          const gptInsight = data.gptInsight;

          if (gptInsight && gptInsight.trim()) {
            // GPT ì¶œë ¥ì„ ê·¸ëŒ€ë¡œ ë Œë”ë§ (ëŒ€í™”í˜• ë‹¨ì¼ ë°•ìŠ¤)
            insightContent.innerHTML = formatGptText(gptInsight);
            insightSection.style.display = 'block';
            console.log('[GPT Insight] Rendered as conversational text');
          } else {
            renderDefaultInsight();
          }
        } catch (e) {
          console.error('[GPT Insight] Failed to render:', e);
          renderDefaultInsight();
        }
      }

      /**
       * GPT í…ìŠ¤íŠ¸ë¥¼ HTMLë¡œ í¬ë§·íŒ…
       * - ì¤„ë°”ê¿ˆì„ <br>ë¡œ ë³€í™˜
       * - ë¬¸ë‹¨ êµ¬ë¶„ ì²˜ë¦¬
       */
      function formatGptText(text) {
        // ì¤„ë°”ê¿ˆ(\n\n)ì„ ë¬¸ë‹¨ìœ¼ë¡œ, ë‹¨ì¼ ì¤„ë°”ê¿ˆ(\n)ì„ <br>ë¡œ ë³€í™˜
        return text
          .split(/\n\n+/)
          .map(para => `<p class="gpt-insight-text">${para.replace(/\n/g, '<br>')}</p>`)
          .join('');
      }

      /**
       * ê¸°ë³¸ ì¸ì‚¬ì´íŠ¸ (GPT ë°ì´í„° ì—†ì„ ë•Œ)
       */
      function renderDefaultInsight() {
        const insightContent = document.getElementById('gptInsightContent');
        if (!insightContent) return;
        
        const precision = baseTotal > 0 ? ((baseAge / baseTotal) * 100).toFixed(0) : 0;
        
        insightContent.innerHTML = `
          <p class="gpt-insight-text">
            í˜„ì¬ ì§„ë£Œê¶Œ ë‚´ <strong>${baseTotal.toLocaleString()}ëª…</strong>ì˜ ê°€ë§ í™˜ìê°€ í™œë™í•˜ê³  ìˆìŠµë‹ˆë‹¤.
            ì´ ì¤‘ <strong>${precision}%</strong>ê°€ 30ëŒ€ í•µì‹¬ ì†Œë¹„ì¸µì…ë‹ˆë‹¤.
          </p>
          <p class="gpt-insight-text">
            ì´ ìƒíƒœì—ì„œëŠ” ë¨¼ì € ë…¸ì¶œë˜ëŠ” ë³‘ì›ì´ ê¸°ì¤€ì ì´ ë©ë‹ˆë‹¤.
            ìƒì„¸í•œ ì „ëµì€ ë‹´ë‹¹ìì™€ ìƒë‹´ì„ í†µí•´ ì•ˆë‚´ë°›ìœ¼ì‹¤ ìˆ˜ ìˆìŠµë‹ˆë‹¤.
          </p>
        `;
      }

      // -------------------------------------------------------
      // 5. Initialization
      // -------------------------------------------------------
      
      updateDashboard();
      setTimeout(loadKakaoMap, 100);
      renderGptInsight();

    });
  </script>

  <!-- Contextual Inquiry JS Module -->
  <script src="../../assets/js/inquiry.js"></script>
  <script>
    // Initialize Inquiry Module with dashboard data
    document.addEventListener('DOMContentLoaded', () => {
      // Wait for dashboard data to be ready
      setTimeout(() => {
        const storedData = localStorage.getItem('touchadData');
        const data = storedData ? JSON.parse(storedData) : {};
        
        let baseTotal = 12500, baseAge = 4500, baseGender = 8200;
        
        if (data.dunjugoValues && data.dunjugoValues.length > 0) {
          baseTotal = data.dunjugoValues[0]?.value || 12500;
          baseAge = data.dunjugoValues[1]?.value || 4500;
          baseGender = data.dunjugoValues[2]?.value || 8200;
        } else if (data.resData && data.resData.length > 0) {
          baseTotal = data.resData[0]?.dunjugo || data.resData[0]?.target || 12500;
          baseAge = data.resData[1]?.dunjugo || data.resData[1]?.target || 4500;
          baseGender = data.resData[2]?.dunjugo || data.resData[2]?.target || 8200;
        }
        
        if (window.InquiryModule) {
          window.InquiryModule.init({ 
            baseTotal, 
            baseAge, 
            baseGender,
            source_page: 'newresult.html' // DB source_type ë™ê¸°í™”ìš©
          });
        }
      }, 100);
    });
  </script>
</body>
</html>
