<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TouchAd Admin - Order List</title>
    <link rel="stylesheet" href="../assets/css/style.css">
    <link rel="stylesheet" href="./assets/css/admin.css">
    <link href="https://cdn.jsdelivr.net/gh/sun-typeface/SUIT/fonts/variable/woff2/SUIT-Variable.css" rel="stylesheet">
</head>
<body class="admin-body">

    <header class="admin-header">
        <div class="admin-logo">TouchAd Admin</div>
        <nav class="admin-nav">
            <a href="index.html">Dashboard</a>
            <a href="inquiry_list.html">Inquiry (Sales)</a>
            <a href="order_list.html" class="active">Orders</a>
        </nav>
        <div class="admin-user-info text-small">Manager님</div>
    </header>

    <main class="admin-container">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
            <h2 class="section-title" style="text-align: left; margin: 0; font-size: 1.5rem;">Order Management</h2>
            <div class="text-small text-muted" id="totalCount">Loading...</div>
        </div>

        <!-- Filter Bar -->
        <div class="filter-bar">
            <select class="filter-select" id="filterStatus">
                <option value="">Status (All)</option>
                <option value="DRAFT">DRAFT (작성중)</option>
                <option value="CONFIRMED">CONFIRMED (확정)</option>
                <option value="ORDERED">ORDERED (발주)</option>
                <option value="RUNNING">RUNNING (집행중)</option>
                <option value="DONE">DONE (완료)</option>
                <option value="CANCELLED">CANCELLED (취소)</option>
            </select>
            <button class="btn-primary" style="padding: 6px 16px; font-size: 0.9rem;" id="applyFilterBtn">Filter</button>
        </div>

        <!-- Order Table -->
        <div class="data-table-wrapper">
            <table class="data-table">
                <thead>
                    <tr>
                        <th style="width: 100px;">Status</th>
                        <th style="width: 150px;">Order ID</th>
                        <th>Linked Inquiry</th>
                        <th style="text-align: right;">Amount (KRW)</th>
                        <th style="width: 150px;">Created Date</th>
                        <th>Admin Memo</th>
                        <th style="width: 80px;">Action</th>
                    </tr>
                </thead>
                <tbody id="orderTableBody">
                    <tr><td colspan="7" style="text-align:center; padding:40px;">Loading...</td></tr>
                </tbody>
            </table>
        </div>
        
        <!-- Pagination -->
        <div style="text-align: center; margin-top: 20px;" id="paginationArea">
            <button class="btn-secondary" id="prevBtn" disabled>Prev</button>
            <span style="margin: 0 10px; font-size: 0.9rem;" id="pageInfo">Page 1 of 1</span>
            <button class="btn-secondary" id="nextBtn">Next</button>
        </div>
    </main>

    <!-- Admin API Module -->
    <script src="./assets/js/admin-api.js"></script>
    
    <script>
    document.addEventListener('DOMContentLoaded', () => {
        // 상태 관리
        let currentPage = 1;
        let totalPages = 1;
        let currentFilters = {};

        // 요소 참조
        const tableBody = document.getElementById('orderTableBody');
        const totalCountEl = document.getElementById('totalCount');
        const pageInfoEl = document.getElementById('pageInfo');
        const prevBtn = document.getElementById('prevBtn');
        const nextBtn = document.getElementById('nextBtn');

        // Order 리스트 로드
        async function loadOrders() {
            tableBody.innerHTML = '<tr><td colspan="7" style="text-align:center; padding:40px;">Loading...</td></tr>';

            try {
                const filters = {
                    ...currentFilters,
                    page: currentPage,
                    limit: 20
                };

                const data = await AdminAPI.orders.list(filters);
                
                totalCountEl.textContent = `Total ${data.pagination.total} orders`;
                totalPages = data.pagination.totalPages;
                pageInfoEl.textContent = `Page ${data.pagination.page} of ${totalPages || 1}`;

                prevBtn.disabled = currentPage <= 1;
                nextBtn.disabled = currentPage >= totalPages;

                renderTable(data.orders);
            } catch (err) {
                tableBody.innerHTML = `<tr><td colspan="7" style="text-align:center; padding:40px; color:#d32f2f;">Error: ${err.message}</td></tr>`;
            }
        }

        // 테이블 렌더링
        function renderTable(orders) {
            if (!orders || orders.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="7" style="text-align:center; padding:40px; color:#999;">No orders found</td></tr>';
                return;
            }

            tableBody.innerHTML = orders.map(order => {
                // Inquiry 요약
                const inquirySummary = order.inquiry_summary;
                const hospitalName = inquirySummary?.hospital_name || '-';
                const inquiryLink = order.inquiry_id 
                    ? `<a href="inquiry_detail.html?id=${order.inquiry_id}" style="text-decoration: underline; color: #666;">${order.inquiry_id}</a><br><span class="text-small text-muted">${hospitalName}</span>`
                    : '-';

                // 완료된 항목 스타일
                const isDone = order.status === 'DONE' || order.status === 'CANCELLED';
                const rowStyle = isDone ? 'background-color: #f9f9f9; color: #999;' : '';

                return `
                <tr style="${rowStyle}">
                    <td>${AdminAPI.utils.statusBadge(order.status)}</td>
                    <td style="font-weight: 600;">${order.order_id}</td>
                    <td>${inquiryLink}</td>
                    <td style="text-align: right; font-weight: 700;">${order.amount ? AdminAPI.utils.formatNumber(order.amount) : '-'}</td>
                    <td>${AdminAPI.utils.formatDate(order.created_at).split(' ')[0]}</td>
                    <td>${order.memo || '-'}</td>
                    <td>
                        <button class="btn-secondary status-btn" data-order-id="${order.order_id}" data-current-status="${order.status}" style="padding: 4px 8px; font-size: 0.8rem;">Update</button>
                    </td>
                </tr>
                `;
            }).join('');

            // 상태 변경 버튼 이벤트
            document.querySelectorAll('.status-btn').forEach(btn => {
                btn.addEventListener('click', async () => {
                    const orderId = btn.dataset.orderId;
                    const currentStatus = btn.dataset.currentStatus;
                    
                    const nextStatuses = {
                        'DRAFT': 'CONFIRMED',
                        'CONFIRMED': 'ORDERED',
                        'ORDERED': 'RUNNING',
                        'RUNNING': 'DONE'
                    };

                    const nextStatus = nextStatuses[currentStatus];
                    if (!nextStatus) {
                        alert('이미 최종 상태입니다.');
                        return;
                    }

                    if (!confirm(`상태를 ${currentStatus} → ${nextStatus}로 변경하시겠습니까?`)) return;

                    try {
                        await AdminAPI.orders.updateStatus(orderId, nextStatus);
                        alert('상태가 변경되었습니다.');
                        loadOrders();
                    } catch (err) {
                        alert('상태 변경 실패: ' + err.message);
                    }
                });
            });
        }

        // 필터 적용
        document.getElementById('applyFilterBtn').addEventListener('click', () => {
            currentFilters = {};
            const status = document.getElementById('filterStatus').value;
            if (status) currentFilters.status = status;
            currentPage = 1;
            loadOrders();
        });

        // 페이지네이션
        prevBtn.addEventListener('click', () => {
            if (currentPage > 1) {
                currentPage--;
                loadOrders();
            }
        });

        nextBtn.addEventListener('click', () => {
            if (currentPage < totalPages) {
                currentPage++;
                loadOrders();
            }
        });

        // 초기 로드
        loadOrders();
    });
    </script>
</body>
</html>
