<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TouchAd Admin - Inquiry Detail</title>
    <link rel="stylesheet" href="../assets/css/style.css">
    <link rel="stylesheet" href="./assets/css/admin.css">
    <link href="https://cdn.jsdelivr.net/gh/sun-typeface/SUIT/fonts/variable/woff2/SUIT-Variable.css" rel="stylesheet">
    <style>
        .map-placeholder {
            width: 100%;
            height: 250px;
            background: #eee;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #999;
            border-radius: 4px;
            margin-bottom: 20px;
        }
        .metric-kv {
            display: flex;
            justify-content: space-between;
            border-bottom: 1px solid #eee;
            padding: 8px 0;
            font-size: 0.9rem;
        }
        .metric-kv:last-child { border-bottom: none; }
        .metric-label { color: #666; }
        .metric-val { font-weight: 600; color: #000; }
        
        .timeline-item {
            position: relative;
            padding-left: 20px;
            margin-bottom: 15px;
            font-size: 0.85rem;
        }
        .timeline-item::before {
            content: '';
            position: absolute;
            left: 0;
            top: 6px;
            width: 8px;
            height: 8px;
            background: #ddd;
            border-radius: 50%;
        }
        .timeline-date { font-weight: 600; margin-bottom: 2px; }
        .timeline-content { color: #555; }
        
        .loading-state { text-align: center; padding: 60px; color: #999; }
        .error-state { text-align: center; padding: 60px; color: #d32f2f; }
    </style>
</head>
<body class="admin-body">

    <header class="admin-header">
        <div class="admin-logo">TouchAd Admin</div>
        <nav class="admin-nav">
            <a href="index.html">Dashboard</a>
            <a href="inquiry_list.html" class="active">Inquiry (Sales)</a>
            <a href="order_list.html">Orders</a>
        </nav>
        <div class="admin-user-info text-small">Managerë‹˜</div>
    </header>

    <main class="admin-container" id="mainContainer">
        <!-- Breadcrumb / Back -->
        <div class="mb-4">
            <a href="inquiry_list.html" style="font-size: 0.9rem; color: #666;">â† Back to List</a>
        </div>

        <!-- Loading State -->
        <div id="loadingState" class="loading-state">Loading...</div>
        
        <!-- Error State -->
        <div id="errorState" class="error-state" style="display:none;"></div>

        <!-- Content (ë™ì  ë Œë”ë§) -->
        <div id="contentArea" style="display:none;">
            <div class="detail-grid">
                
                <!-- LEFT: Context & Analysis (Decision Basis) -->
                <div class="detail-left">
                    
                    <div class="detail-section">
                        <div class="detail-header">
                            Simulation Snapshot
                            <a href="#" class="text-small" style="color:blue; font-weight:400;" id="openOriginalView">Open Original View â†—</a>
                        </div>
                        
                        <!-- 3ì´ˆ ë¸Œë¦¬í•‘ ìš”ì•½ ë°•ìŠ¤ -->
                        <div class="summary-box" id="summaryBox">
                            <strong>í•œëˆˆ ìš”ì•½:</strong> <span id="summaryText">Loading...</span>
                        </div>
                        
                        <!-- Sim Summary High Level -->
                        <div style="display: flex; gap: 20px; margin-bottom: 20px; background: #fffde7; padding: 15px; border-radius: 4px;">
                            <div>
                                <div class="text-small text-muted">Total Population</div>
                                <div style="font-size: 1.8rem; font-weight: 800;" id="totalPopulation">-</div>
                            </div>
                            <div style="border-left: 1px solid #ddd; padding-left: 20px;">
                                <div class="text-small text-muted">Targeting</div>
                                <div style="font-size: 1.1rem; font-weight: 600;" id="targetingInfo">-</div>
                            </div>
                        </div>

                        <!-- Map Context -->
                        <div class="map-placeholder">
                            [ Kakao Map Snapshot / Radius Preview ]
                        </div>

                        <!-- Detailed Metrics -->
                        <h4 style="font-size: 0.9rem; margin-bottom: 10px;">Analysis Details</h4>
                        <div class="metric-kv">
                            <span class="metric-label">Source Type</span>
                            <span class="metric-val" id="sourceType">-</span>
                        </div>
                        <div class="metric-kv">
                            <span class="metric-label">Source Page</span>
                            <span class="metric-val" id="sourcePage">-</span>
                        </div>
                        <div class="metric-kv">
                            <span class="metric-label">Session ID</span>
                            <span class="metric-val" id="sessionId">-</span>
                        </div>
                        <div class="metric-kv">
                            <span class="metric-label">Created At</span>
                            <span class="metric-val" id="createdAt">-</span>
                        </div>
                    </div>
                </div>

                <!-- RIGHT: Action & Workflow -->
                <div class="detail-right">
                    
                    <!-- Client Info -->
                    <div class="detail-section">
                        <div class="detail-header">
                            Client Information
                            <span id="statusBadge"></span>
                        </div>
                        
                        <div class="mb-4">
                            <div class="text-small text-muted">Hospital Name</div>
                            <div style="font-size: 1.2rem; font-weight: 700;" id="hospitalName">-</div>
                        </div>

                        <div class="mb-4">
                            <div class="text-small text-muted">Contact Info</div>
                            <div id="contactInfo" style="font-size: 1.1rem; font-family: monospace; letter-spacing: 1px;">
                                Loading...
                            </div>
                        </div>

                        <div>
                            <div class="text-small text-muted">Interest Tags</div>
                            <div class="mt-2" id="interestTags">-</div>
                        </div>
                    </div>

                    <!-- Workflow Actions -->
                    <div class="detail-section">
                        <div class="detail-header">Process Workflow</div>
                        
                        <div class="mb-4">
                            <label class="text-small" style="display:block; margin-bottom: 5px;">Change Status</label>
                            <select class="filter-select" style="width: 100%;" id="statusSelect">
                                <option value="new">NEW (ì‹ ê·œ)</option>
                                <option value="contacted">CONTACTED (í†µí™”ì™„ë£Œ)</option>
                                <option value="qualified">QUALIFIED (ê°€ë§ê³ ê°)</option>
                                <option value="converted">CONVERTED (ê³„ì•½ì™„ë£Œ)</option>
                                <option value="archived">ARCHIVED (ë³´ê´€)</option>
                            </select>
                            <button class="btn-secondary mt-2" style="width:100%;" id="updateStatusBtn">ìƒíƒœ ë³€ê²½</button>
                        </div>

                        <button class="btn-primary" style="width: 100%; padding: 12px;" id="createOrderBtn" disabled>
                            ğŸ“ Create Order (Unlock at Qualified)
                        </button>
                        <div class="text-small text-muted text-center mt-2">
                            * Status must be 'QUALIFIED' to create order.
                        </div>
                    </div>

                    <!-- Internal Memo -->
                    <div class="detail-section">
                        <div class="detail-header">Operation History</div>
                        
                        <div id="historyTimeline">
                            <!-- ë™ì  ë Œë”ë§ -->
                        </div>
                        
                        <textarea id="memoInput" class="mt-4" placeholder="Add internal memo..." style="width: 100%; border: 1px solid #ddd; padding: 10px; border-radius: 4px; font-family: inherit; font-size: 0.9rem;" rows="3"></textarea>
                        <button class="btn-secondary mt-2" style="font-size: 0.8rem; padding: 4px 10px;" id="addNoteBtn">Add Note</button>
                    </div>

                </div>
            </div>
        </div>
    </main>

    <!-- Admin API Module -->
    <script src="./assets/js/admin-api.js"></script>
    
    <script>
    document.addEventListener('DOMContentLoaded', async () => {
        // URLì—ì„œ inquiry_id ì¶”ì¶œ
        const urlParams = new URLSearchParams(window.location.search);
        const inquiryId = urlParams.get('id');

        if (!inquiryId) {
            showError('Inquiry IDê°€ ì—†ìŠµë‹ˆë‹¤. ë¦¬ìŠ¤íŠ¸ì—ì„œ ì„ íƒí•´ì£¼ì„¸ìš”.');
            return;
        }

        // ìš”ì†Œ ì°¸ì¡°
        const loadingState = document.getElementById('loadingState');
        const errorState = document.getElementById('errorState');
        const contentArea = document.getElementById('contentArea');

        // ë°ì´í„° ë¡œë“œ
        try {
            const inquiry = await AdminAPI.inquiries.view(inquiryId);
            loadingState.style.display = 'none';
            contentArea.style.display = 'block';
            renderInquiry(inquiry);
        } catch (err) {
            showError(`Error: ${err.message}`);
        }

        function showError(msg) {
            loadingState.style.display = 'none';
            errorState.style.display = 'block';
            errorState.textContent = msg;
        }

        function renderInquiry(inq) {
            // ìƒíƒœ ë°°ì§€
            document.getElementById('statusBadge').innerHTML = AdminAPI.utils.statusBadge(inq.status);

            // context_snapshot íŒŒì‹±
            const ctx = inq.context_snapshot || {};
            const resData = ctx.resData_snapshot || {};

            // ê¸°ë³¸ ì •ë³´
            document.getElementById('hospitalName').textContent = ctx.hospital_name || '(ë¯¸ì…ë ¥)';
            document.getElementById('sourceType').textContent = inq.source_type || '-';
            document.getElementById('sourcePage').textContent = inq.source_page || '-';
            document.getElementById('sessionId').textContent = inq.session_id || '-';
            document.getElementById('createdAt').textContent = AdminAPI.utils.formatDate(inq.created_at);

            // Population & Targeting
            document.getElementById('totalPopulation').textContent = AdminAPI.utils.formatNumber(resData.total);
            document.getElementById('targetingInfo').textContent = 
                `${ctx.hospital_name || '-'} / ${resData.radius || '-'}`;

            // 3ì´ˆ ë¸Œë¦¬í•‘
            const total = resData.total || 0;
            const summaryText = total >= 50000 
                ? `ëŒ€ê·œëª¨ ì‹œì¥ (${AdminAPI.utils.formatNumber(total)}ëª…), ì¦‰ì‹œ ì»¨íƒ ê¶Œì¥`
                : total >= 10000 
                    ? `ì¤‘ê·œëª¨ ì‹œì¥ (${AdminAPI.utils.formatNumber(total)}ëª…), ê²€í†  í›„ ì»¨íƒ`
                    : `ì†Œê·œëª¨ ì‹œì¥ (${AdminAPI.utils.formatNumber(total)}ëª…)`;
            document.getElementById('summaryText').textContent = summaryText;

            // ì—°ë½ì²˜ (ë³µí˜¸í™”ë¨)
            const phone = inq.contact_phone || '-';
            const email = inq.contact_email || '-';
            document.getElementById('contactInfo').innerHTML = `
                <div style="color: #1976d2;">ğŸ“ ${phone}</div>
                <div style="color: #666; font-size: 0.9rem;">âœ‰ï¸ ${email}</div>
            `;

            // Interest Tags
            const tags = (inq.interest_tags || []).map(tag => 
                `<span style="background:#f5f5f5; padding: 4px 8px; border-radius: 4px; font-size: 0.85rem; margin-right: 5px;">#${tag}</span>`
            ).join('') || '-';
            document.getElementById('interestTags').innerHTML = tags;

            // ìƒíƒœ ì„ íƒ ê¸°ë³¸ê°’
            document.getElementById('statusSelect').value = inq.status;

            // Qualified ì´ìƒì¼ ë•Œ Order ìƒì„± ë²„íŠ¼ í™œì„±í™”
            const createOrderBtn = document.getElementById('createOrderBtn');
            if (inq.status === 'qualified' || inq.status === 'converted') {
                createOrderBtn.disabled = false;
                createOrderBtn.textContent = 'ğŸ“ Create Order';
            }

            // History Timeline
            document.getElementById('historyTimeline').innerHTML = `
                <div class="timeline-item">
                    <div class="timeline-date">${AdminAPI.utils.formatDate(inq.created_at)}</div>
                    <div class="timeline-content">Inquiry created via [${inq.source_page || 'unknown'}]</div>
                </div>
                ${inq.admin_reply ? `
                <div class="timeline-item">
                    <div class="timeline-date">${AdminAPI.utils.formatDate(inq.replied_at)}</div>
                    <div class="timeline-content">${inq.admin_reply}</div>
                </div>
                ` : ''}
            `;

            // ìƒíƒœ ë³€ê²½ ì´ë²¤íŠ¸
            document.getElementById('updateStatusBtn').addEventListener('click', async () => {
                const newStatus = document.getElementById('statusSelect').value;
                const note = document.getElementById('memoInput').value.trim();

                try {
                    await AdminAPI.inquiries.updateStatus(inquiryId, newStatus, note || null);
                    alert('ìƒíƒœê°€ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤.');
                    location.reload();
                } catch (err) {
                    alert('ìƒíƒœ ë³€ê²½ ì‹¤íŒ¨: ' + err.message);
                }
            });

            // Order ìƒì„± ì´ë²¤íŠ¸
            createOrderBtn.addEventListener('click', async () => {
                if (!confirm('ì´ Inquiry ê¸°ë°˜ìœ¼ë¡œ Orderë¥¼ ìƒì„±í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;

                const memo = prompt('Order ë©”ëª¨ (ì„ íƒ):') || '';

                try {
                    const result = await AdminAPI.orders.create(inquiryId, memo);
                    alert(`Orderê°€ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤.\nOrder ID: ${result.order_id}`);
                    window.location.href = `order_list.html`;
                } catch (err) {
                    alert('Order ìƒì„± ì‹¤íŒ¨: ' + err.message);
                }
            });
        }
    });
    </script>
</body>
</html>
