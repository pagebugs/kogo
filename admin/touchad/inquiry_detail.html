<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kogo ê´€ë¦¬ì - í„°ì¹˜ì• ë“œ ë¬¸ì˜ ìƒì„¸</title>
    <link rel="stylesheet" href="../../assets/css/common/tokens.css">
    <link rel="stylesheet" href="../../assets/css/common/base.css">
    <link rel="stylesheet" href="../../assets/css/style.css">
    <link rel="stylesheet" href="../assets/css/admin.css">
    <link href="https://cdn.jsdelivr.net/gh/sun-typeface/SUIT/fonts/variable/woff2/SUIT-Variable.css" rel="stylesheet">
</head>
<body class="admin-body">

    <!-- 1depth: Global Navigation Bar -->
    <nav class="global-nav">
        <div class="global-nav-logo">Kogo</div>
        <div class="global-nav-menu">
            <a href="../index.html">ëŒ€ì‹œë³´ë“œ</a>
            <div class="dropdown">
                <a href="#" class="active">ì„œë¹„ìŠ¤ ê´€ë¦¬ â–¾</a>
                <div class="dropdown-content">
                    <a href="index.html" class="active">í„°ì¹˜ì• ë“œ</a>
                    <a href="#" style="color:#666;">ì½”ê³ ì¼€ì–´ (ì˜ˆì •)</a>
                </div>
            </div>
            <a href="#" style="color:#666;">íšŒì› ê´€ë¦¬</a>
            <a href="#" style="color:#666;">ë¹Œë§</a>
            <a href="#" style="color:#666;">ì„¤ì •</a>
        </div>
        <div class="global-nav-user">ê´€ë¦¬ìë‹˜</div>
    </nav>

    <!-- 3depth: TouchAd Sub Navigation -->
    <div class="service-nav">
        <span class="service-nav-title">í„°ì¹˜ì• ë“œ</span>
        <div class="service-nav-menu">
            <a href="index.html">ëŒ€ì‹œë³´ë“œ</a>
            <a href="inquiry_list.html" class="active">ë¬¸ì˜ ê´€ë¦¬</a>
            <a href="order_list.html">ì£¼ë¬¸ ê´€ë¦¬</a>
            <a href="#" style="color:#999;">ë¦¬í¬íŠ¸</a>
            <a href="#" style="color:#999;">ì„¤ì •</a>
        </div>
    </div>

    <main class="admin-container" id="mainContainer">
        <!-- Breadcrumb / Back -->
        <div class="mb-4">
            <a href="inquiry_list.html" style="font-size: 0.9rem; color: #666;">â† ëª©ë¡ìœ¼ë¡œ ëŒì•„ê°€ê¸°</a>
        </div>

        <!-- Loading State -->
        <div id="loadingState" class="loading-state">ë¡œë”© ì¤‘...</div>
        
        <!-- Error State -->
        <div id="errorState" class="error-state" style="display:none;"></div>

        <!-- Content (ë™ì  ë Œë”ë§) -->
        <div id="contentArea" style="display:none;">
            <div class="detail-grid">
                
                <!-- LEFT: Context & Analysis (Decision Basis) -->
                <div class="detail-left">
                    
                    <div class="detail-section">
                        <div class="detail-header">
                            ì‹œë®¬ë ˆì´ì…˜ ìŠ¤ëƒ…ìƒ·
                            <a href="#" class="text-small" style="color:blue; font-weight:400;" id="openOriginalView">ì›ë³¸ ë³´ê¸° â†—</a>
                        </div>
                        
                        <!-- 3ì´ˆ ë¸Œë¦¬í•‘ ìš”ì•½ ë°•ìŠ¤ -->
                        <div class="summary-box" id="summaryBox">
                            <strong>í•œëˆˆ ìš”ì•½:</strong> <span id="summaryText">ë¡œë”© ì¤‘...</span>
                        </div>
                        
                        <!-- Sim Summary High Level -->
                        <div style="display: flex; gap: 20px; margin-bottom: 20px; background: #fffde7; padding: 15px; border-radius: 4px;">
                            <div>
                                <div class="text-small text-muted">ì ì¬ ê³ ê° ìˆ˜</div>
                                <div style="font-size: 1.8rem; font-weight: 800;" id="totalPopulation">-</div>
                            </div>
                            <div style="border-left: 1px solid #ddd; padding-left: 20px;">
                                <div class="text-small text-muted">íƒ€ê²ŸíŒ…</div>
                                <div style="font-size: 1.1rem; font-weight: 600;" id="targetingInfo">-</div>
                            </div>
                        </div>

                        <!-- Map Context -->
                        <div class="map-placeholder">
                            [ ì¹´ì¹´ì˜¤ë§µ ìŠ¤ëƒ…ìƒ· / ë°˜ê²½ ë¯¸ë¦¬ë³´ê¸° ]
                        </div>

                        <!-- Detailed Metrics -->
                        <h4 style="font-size: 0.9rem; margin-bottom: 10px;">ë¶„ì„ ìƒì„¸</h4>
                        <div class="metric-kv">
                            <span class="metric-label">ìœ ì… ìœ í˜•</span>
                            <span class="metric-val" id="sourceType">-</span>
                        </div>
                        <div class="metric-kv">
                            <span class="metric-label">ìœ ì… í˜ì´ì§€</span>
                            <span class="metric-val" id="sourcePage">-</span>
                        </div>
                        <div class="metric-kv">
                            <span class="metric-label">ì„¸ì…˜ ID</span>
                            <span class="metric-val" id="sessionId">-</span>
                        </div>
                        <div class="metric-kv">
                            <span class="metric-label">ìƒì„±ì¼</span>
                            <span class="metric-val" id="createdAt">-</span>
                        </div>
                    </div>
                </div>

                <!-- RIGHT: Action & Workflow -->
                <div class="detail-right">
                    
                    <!-- Client Info -->
                    <div class="detail-section">
                        <div class="detail-header">
                            ê³ ê° ì •ë³´
                            <span id="statusBadge"></span>
                        </div>
                        
                        <div class="mb-4">
                            <div class="text-small text-muted">ë³‘ì›ëª…</div>
                            <div style="font-size: 1.2rem; font-weight: 700;" id="hospitalName">-</div>
                        </div>

                        <div class="mb-4">
                            <div class="text-small text-muted">ì—°ë½ì²˜</div>
                            <div id="contactInfo" style="font-size: 1.1rem; font-family: monospace; letter-spacing: 1px;">
                                ë¡œë”© ì¤‘...
                            </div>
                        </div>

                        <div>
                            <div class="text-small text-muted">ê´€ì‹¬ íƒœê·¸</div>
                            <div class="mt-2" id="interestTags">-</div>
                        </div>
                    </div>

                    <!-- Workflow Actions -->
                    <div class="detail-section">
                        <div class="detail-header">ì²˜ë¦¬ ì›Œí¬í”Œë¡œìš°</div>
                        
                        <div class="mb-4">
                            <label class="text-small" style="display:block; margin-bottom: 5px;">ìƒíƒœ ë³€ê²½</label>
                            <select class="filter-select" style="width: 100%;" id="statusSelect">
                                <option value="new">NEW (ì‹ ê·œ)</option>
                                <option value="contacted">CONTACTED (ì»¨íƒ ì™„ë£Œ)</option>
                                <option value="qualified">QUALIFIED (ì˜ì—… ì¤€ë¹„)</option>
                                <option value="converted">CONVERTED (ì „í™˜ ì™„ë£Œ)</option>
                                <option value="archived">ARCHIVED (ë³´ê´€)</option>
                            </select>
                            <button class="btn-secondary mt-2" style="width:100%;" id="updateStatusBtn">ìƒíƒœ ë³€ê²½</button>
                        </div>

                        <button class="btn-primary" style="width: 100%; padding: 12px;" id="createOrderBtn" disabled>
                            ğŸ“ ì£¼ë¬¸ ìƒì„± (Qualified ìƒíƒœì—ì„œ í™œì„±í™”)
                        </button>
                        <div class="text-small text-muted text-center mt-2">
                            * ìƒíƒœê°€ 'QUALIFIED' ì´ìƒì´ì–´ì•¼ ì£¼ë¬¸ ìƒì„± ê°€ëŠ¥
                        </div>
                    </div>

                    <!-- Internal Memo -->
                    <div class="detail-section">
                        <div class="detail-header">ì²˜ë¦¬ ì´ë ¥</div>
                        
                        <div id="historyTimeline">
                            <!-- ë™ì  ë Œë”ë§ -->
                        </div>
                        
                        <textarea id="memoInput" class="mt-4" placeholder="ë‚´ë¶€ ë©”ëª¨ ì¶”ê°€..." style="width: 100%; border: 1px solid #ddd; padding: 10px; border-radius: 4px; font-family: inherit; font-size: 0.9rem;" rows="3"></textarea>
                        <button class="btn-secondary mt-2" style="font-size: 0.8rem; padding: 4px 10px;" id="addNoteBtn">ë©”ëª¨ ì¶”ê°€</button>
                    </div>

                </div>
            </div>
        </div>
    </main>

    <!-- Admin JS Modules -->
    <script src="../assets/js/admin-api.js"></script>
    <script src="../assets/js/admin.js"></script>
    
    <script>
    document.addEventListener('DOMContentLoaded', async () => {
        const urlParams = new URLSearchParams(window.location.search);
        const inquiryId = urlParams.get('id');

        if (!inquiryId) {
            showError('Inquiry IDê°€ ì—†ìŠµë‹ˆë‹¤. ëª©ë¡ì—ì„œ ì„ íƒí•´ì£¼ì„¸ìš”.');
            return;
        }

        const loadingState = document.getElementById('loadingState');
        const errorState = document.getElementById('errorState');
        const contentArea = document.getElementById('contentArea');

        try {
            const inquiry = await AdminAPI.inquiries.view(inquiryId);
            loadingState.style.display = 'none';
            contentArea.style.display = 'block';
            renderInquiry(inquiry);
        } catch (err) {
            showError(`ì˜¤ë¥˜: ${err.message}`);
        }

        function showError(msg) {
            loadingState.style.display = 'none';
            errorState.style.display = 'block';
            errorState.textContent = msg;
        }

        function renderInquiry(inq) {
            document.getElementById('statusBadge').innerHTML = AdminAPI.utils.statusBadge(inq.status);

            const ctx = inq.context_snapshot || {};
            const resData = ctx.resData_snapshot || {};

            document.getElementById('hospitalName').textContent = ctx.hospital_name || '(ë¯¸ì…ë ¥)';
            document.getElementById('sourceType').textContent = inq.source_type || '-';
            document.getElementById('sourcePage').textContent = inq.source_page || '-';
            document.getElementById('sessionId').textContent = inq.session_id || '-';
            document.getElementById('createdAt').textContent = AdminAPI.utils.formatDate(inq.created_at);

            document.getElementById('totalPopulation').textContent = AdminAPI.utils.formatNumber(resData.total);
            document.getElementById('targetingInfo').textContent = 
                `${ctx.hospital_name || '-'} / ${resData.radius || '-'}`;

            const total = resData.total || 0;
            const summaryText = total >= 50000 
                ? `ëŒ€ê·œëª¨ ì‹œì¥ (${AdminAPI.utils.formatNumber(total)}ëª…), ì¦‰ì‹œ ì»¨íƒ ê¶Œì¥`
                : total >= 10000 
                    ? `ì¤‘ê·œëª¨ ì‹œì¥ (${AdminAPI.utils.formatNumber(total)}ëª…), ê²€í†  í›„ ì»¨íƒ`
                    : `ì†Œê·œëª¨ ì‹œì¥ (${AdminAPI.utils.formatNumber(total)}ëª…)`;
            document.getElementById('summaryText').textContent = summaryText;

            const phone = inq.contact_phone || '-';
            const email = inq.contact_email || '-';
            document.getElementById('contactInfo').innerHTML = `
                <div style="color: #1976d2;">ğŸ“ ${phone}</div>
                <div style="color: #666; font-size: 0.9rem;">âœ‰ï¸ ${email}</div>
            `;

            const tags = (inq.interest_tags || []).map(tag => 
                `<span style="background:#f5f5f5; padding: 4px 8px; border-radius: 4px; font-size: 0.85rem; margin-right: 5px;">#${tag}</span>`
            ).join('') || '-';
            document.getElementById('interestTags').innerHTML = tags;

            document.getElementById('statusSelect').value = inq.status;

            const createOrderBtn = document.getElementById('createOrderBtn');
            if (inq.status === 'qualified' || inq.status === 'converted') {
                createOrderBtn.disabled = false;
                createOrderBtn.textContent = 'ğŸ“ ì£¼ë¬¸ ìƒì„±';
            }

            document.getElementById('historyTimeline').innerHTML = `
                <div class="timeline-item">
                    <div class="timeline-date">${AdminAPI.utils.formatDate(inq.created_at)}</div>
                    <div class="timeline-content">[${inq.source_page || 'unknown'}]ì—ì„œ ë¬¸ì˜ ìƒì„±ë¨</div>
                </div>
                ${inq.admin_reply ? `
                <div class="timeline-item">
                    <div class="timeline-date">${AdminAPI.utils.formatDate(inq.replied_at)}</div>
                    <div class="timeline-content">${inq.admin_reply}</div>
                </div>
                ` : ''}
            `;

            document.getElementById('updateStatusBtn').addEventListener('click', async () => {
                const newStatus = document.getElementById('statusSelect').value;
                const note = document.getElementById('memoInput').value.trim();

                try {
                    await AdminAPI.inquiries.updateStatus(inquiryId, newStatus, note || null);
                    alert('ìƒíƒœê°€ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤.');
                    location.reload();
                } catch (err) {
                    alert('ìƒíƒœ ë³€ê²½ ì‹¤íŒ¨: ' + err.message);
                }
            });

            createOrderBtn.addEventListener('click', async () => {
                if (!confirm('ì´ ë¬¸ì˜ ê¸°ë°˜ìœ¼ë¡œ ì£¼ë¬¸ì„ ìƒì„±í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;

                const memo = prompt('ì£¼ë¬¸ ë©”ëª¨ (ì„ íƒ):') || '';

                try {
                    const result = await AdminAPI.orders.create(inquiryId, memo);
                    alert(`ì£¼ë¬¸ì´ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤.\nOrder ID: ${result.order_id}`);
                    window.location.href = `order_list.html`;
                } catch (err) {
                    alert('ì£¼ë¬¸ ìƒì„± ì‹¤íŒ¨: ' + err.message);
                }
            });
        }
    });
    </script>
</body>
</html>
