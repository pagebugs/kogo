<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>í„°ì¹˜ì• ë“œ - ì‹œì¥ ë¶„ì„ ì¸ì‚¬ì´íŠ¸</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/sun-typeface/SUIT/fonts/variable/woff2/SUIT-Variable.css">
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
  <link rel="stylesheet" href="../assets/css/style.css">
  <link rel="stylesheet" href="../assets/css/insight.css">
  <link rel="stylesheet" href="../assets/css/gnb.css">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <!-- CONFIG JS (API Key ë“±) -->
  <script src="../assets/js/config.js"></script>
</head>
<body class="has-gnb">

<!-- =========================================================
<!-- HEADER (Loaded Dynamically) -->
<div id="include-header"></div>

  <div class="container dashboard-container">
    
    <!-- 1. Header: Context & Authority -->
    <header class="insight-header">
      <div class="insight-title-group">
        <h1>Market Intelligence</h1>
        <div class="insight-meta">
          <span class="hospital-badge" id="hospitalName">ë³‘ì›ëª…</span>
          <span>ì§„ë£Œê¶Œ ì‹œì¥ ê·œëª¨ ë° íƒ€ê²Ÿ ì§‘ì¤‘ë„ ë¶„ì„</span>
        </div>
      </div>
      <div>
        <span class="text-small text-muted" id="currentDate">2026.01.15 ê¸°ì¤€</span>
      </div>
    </header>

    <!-- 2. KPI Cards: The "Ah-ha" Moment (ì¬í•´ì„ë¨) -->
    <div class="kpi-row">
      <!-- KPI 1: Scale (Market Activity Index) -->
      <div class="kpi-card active" id="card-scale">
        <div>
          <div class="kpi-label">ì›ì¥ë‹˜ì„ ëª¨ë¥´ëŠ” ì ì¬ í™˜ì</div>
          <div class="kpi-value-group">
            <span class="kpi-value" id="val-scale">0</span>
            <span class="kpi-unit">ëª…</span>
          </div>
        </div>
        <div class="kpi-desc">ì§€ê¸ˆ ì´ ìˆœê°„ì—ë„ ê²½ìŸ ë³‘ì›ì„ ì°¾ê³  ìˆìŠµë‹ˆë‹¤</div>
      </div>

      <!-- KPI 2: Precision (Core Target Density) -->
      <div class="kpi-card" id="card-precision">
        <div>
          <div class="kpi-label">30ëŒ€ í•µì‹¬ì¸µ ë¹„ì¤‘</div>
          <div class="kpi-value-group">
            <span class="kpi-value" id="val-precision">0</span>
            <span class="kpi-unit">%</span>
          </div>
        </div>
        <div class="kpi-desc">ì„±í˜•/í”¼ë¶€ ì‹œìˆ  ìµœë‹¤ ì†Œë¹„ ì—°ë ¹ëŒ€</div>
      </div>

      <!-- KPI 3: Relevance (Category Fit) -->
      <div class="kpi-card" id="card-relevance">
        <div>
          <div class="kpi-label">ì—¬ì„± ê³ ê° ì ìœ ìœ¨</div>
          <div class="kpi-value-group">
            <span class="kpi-value" id="val-relevance">0</span>
            <span class="kpi-unit">%</span>
          </div>
        </div>
        <div class="kpi-desc">ë·°í‹°Â·ê±´ê°• ì†Œë¹„ ì£¼ë„ì¸µ</div>
      </div>

      <!-- KPI 4: Reliability (Data Source) -->
      <div class="kpi-card info-card">
        <div>
          <div class="kpi-label">ë°ì´í„° ì‹ ë¢°ë„ ê²€ì¦</div>
          <div class="kpi-value">Verified<br>Real Data</div>
        </div>
        <div class="kpi-desc">ê¸ˆìœµê¶Œ ê²°ì œ ë°ì´í„° ê¸°ë°˜<br>ì‹¤ì‹œê°„ ë¶„ì„ ì™„ë£Œ</div>
      </div>
    </div>

    <!-- 3. Insight Box (New) -->
    <div class="insight-box-row">
      <div class="insight-icon">ğŸ’¡</div>
      <div class="insight-text">
        "ì´ ì§€ì—­ì˜ 30ëŒ€ ì—¬ì„± ë¹„ì¤‘ì€ ì „êµ­ í‰ê·  ëŒ€ë¹„ <span style="color:var(--color-black); font-weight:700;">1.4ë°°</span>ì…ë‹ˆë‹¤. 
        ì„±í˜•/í”¼ë¶€ê³¼ì— ìµœì í™”ëœ ê³ ê´€ì—¬ ì‹œì¥ì…ë‹ˆë‹¤."
      </div>
    </div>

    <!-- 4. Dashboard Body: Interactive Analysis -->
    <div class="dashboard-body">
      
      <!-- Left: Visualization (Chart Panel) -->
      <div class="chart-panel">
        <div class="panel-header">
          <div class="panel-title">íƒ€ê²Ÿ ì„¸ê·¸ë¨¼íŠ¸ êµ¬ì„±</div>
        </div>
        
        <div class="viz-container">
          <!-- 1. Map (Always Top) -->
          <div class="map-section" id="view-map">
            <div id="kakaoMap"></div>
          </div>

          <!-- 2. Chart (Always Bottom) -->
          <div class="chart-section-wrapper" id="view-chart">
            <canvas id="mainChart"></canvas>
          </div>
        </div>
      </div>

      <!-- Right: Simulator Controls & Opportunity -->
      <div class="control-panel">
        
        <!-- Radius Simulation -->
        <div class="control-card">
          <div class="control-title">
            <span>ë°˜ê²½ ì‹œë®¬ë ˆì´ì…˜</span>
          </div>
          <div class="radius-slider-wrapper">
            <div class="radius-track-labels">
              <span>500m</span>
              <span>700m</span>
              <span>1km</span>
            </div>
            <input type="range" class="radius-input" min="0" max="2" step="1" value="2" id="radiusSlider">
          </div>
          
          <div class="radius-feedback">
            <span class="radius-current" id="radiusDisplay">1km</span>
            <span class="radius-context">ë„ë³´ 15ë¶„ ë‚´ì™¸ ì§„ë£Œê¶Œ</span>
          </div>
        </div>

        <!-- Opportunity Alert (New) -->
        <div class="alert-box">
          <div class="alert-title">
            <span>âš¡ Opportunity Alert</span>
          </div>
          <div class="alert-desc">
            ì´ <strong id="alert-target-count">12,500</strong>ëª… ì¤‘ ì›ì¥ë‹˜ ë³‘ì›ì„ ì•„ëŠ” ì‚¬ëŒì€ ëª‡ ëª…ì¼ê¹Œìš”?<br><br>
            í„°ì¹˜ì• ë“œëŠ” <strong>í´ë¦­ë‹¹ 50ì›</strong>ìœ¼ë¡œ ì´ë“¤ì—ê²Œ ë„ë‹¬í•©ë‹ˆë‹¤.<br>
            (ê¸°ì¡´ í‚¤ì›Œë“œ ê´‘ê³  ëŒ€ë¹„ 1/14 ë¹„ìš©)
          </div>
        </div>

      </div>
    </div>

    <!-- =========================================================
         FOOTER (Loaded Dynamically)
    ========================================================= -->
    <div id="include-footer"></div>

  </div>

  <!-- Common Scripts -->
  <script src="../assets/js/gnb.js"></script>
  <script src="../assets/js/ui-loader.js"></script>

  <!-- Sticky CTA Bar (New) -->
  <div class="sticky-cta-bar">
    <div class="cta-container">
      <div class="cta-message">
        <strong id="sticky-target-count">12,000</strong>ëª…ì˜ ì ì¬ í™˜ìì—ê²Œ ë¨¼ì € ë‹¿ìœ¼ì„¸ìš”.
      </div>
      <div class="cta-buttons">
        <a href="#" class="cta-btn cta-btn-secondary" onclick="alert('ì¤€ë¹„ ì¤‘ì…ë‹ˆë‹¤.')">ìƒì„¸ ë¦¬í¬íŠ¸ ë°›ê¸°</a>
        <a href="#" class="cta-btn cta-btn-primary" onclick="alert('ë¬´ë£Œ ìƒë‹´ ì‹ ì²­ì´ ì ‘ìˆ˜ë˜ì—ˆìŠµë‹ˆë‹¤.')">ë¬´ë£Œ ìƒë‹´ ì‹ ì²­</a>
      </div>
    </div>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
      // -------------------------------------------------------
      // 1. Data Loading & Initialization
      // -------------------------------------------------------
      const storedData = localStorage.getItem('touchadData');
      
      // Fallback for direct access without data (Dev Mode)
      // resData[0]: Overall, resData[1]: 30s, resData[2]: Female
      const defaultData = {
        hospitalName: "ì²´í—˜ ë³‘ì›",
        resData: [
          { target: 12500 }, // Total
          { target: 4500 },  // 30s
          { target: 8200 }   // Female
        ]
      };

      const data = storedData ? JSON.parse(storedData) : defaultData;
      
      // Values (ì‹¤ì œ API ì‘ë‹µ êµ¬ì¡°ì— ë§ê²Œ ë§¤í•‘ í•„ìš”)
      // í˜„ì¬ ëŸ°ì»´ êµ¬ì¡°: [{dunjugo: 12500}, {dunjugo: 4500}, ...] í˜•íƒœì¼ ìˆ˜ë„ ìˆìŒ
      // index.htmlì—ì„œì˜ ì €ì¥ ë¡œì§ì„ ë³´ë©´ dunjugoValues ë°°ì—´ë„ ì €ì¥í•¨
      
      // ë¡œì»¬ìŠ¤í† ë¦¬ì§€ êµ¬ì¡° í™•ì¸ (index.html ì°¸ê³ )
      // dunjugoValues: [{index:1, value: ...}, {index:2, value: ...}, ...]
      
      let baseTotal = 0;
      let baseAge = 0;
      let baseGender = 0;

      if (data.dunjugoValues && data.dunjugoValues.length > 0) {
          // dunjugoValues[0] -> Total
          // dunjugoValues[1] -> Age (30s)
          // dunjugoValues[2] -> Gender (Female)
          baseTotal = data.dunjugoValues[0]?.value || 12500;
          baseAge = data.dunjugoValues[1]?.value || 4500;
          baseGender = data.dunjugoValues[2]?.value || 8200;
      } else if (data.resData && data.resData.length > 0) {
          // Fallback to resData direct access if structure differs
           baseTotal = data.resData[0]?.dunjugo || data.resData[0]?.target || 12500;
           baseAge = data.resData[1]?.dunjugo || data.resData[1]?.target || 4500;
           baseGender = data.resData[2]?.dunjugo || data.resData[2]?.target || 8200;
      } else {
           // Complete fallback
           baseTotal = 12500;
           baseAge = 4500;
           baseGender = 8200;
      }

      // UI References
      const elHospitalName = document.getElementById('hospitalName');
      const elDate = document.getElementById('currentDate');
      
      // KPIs
      const elValScale = document.getElementById('val-scale');
      const elValPrecision = document.getElementById('val-precision');
      const elValRelevance = document.getElementById('val-relevance');
      
      // Alerts
      const elAlertTargetCount = document.getElementById('alert-target-count');
      const elStickyTargetCount = document.getElementById('sticky-target-count');

      // Slider
      const elRadiusSlider = document.getElementById('radiusSlider');
      const elRadiusDisplay = document.getElementById('radiusDisplay');

      // Set Metadata
      elHospitalName.textContent = data.hospitalName || "ì²´í—˜ ë³‘ì›";
      const today = new Date();
      elDate.textContent = `${today.getFullYear()}.${String(today.getMonth()+1).padStart(2, '0')}.${String(today.getDate()).padStart(2, '0')} ê¸°ì¤€`;

      // Simulation Config
      const radiusConfig = [
        { label: '500m', multiplier: 0.6, desc: 'ë„ë³´ 7ë¶„ ë‚´ì™¸ í•µì‹¬ ìƒê¶Œ' },
        { label: '700m', multiplier: 0.8, desc: 'ë„ë³´ 10ë¶„ ë‚´ì™¸ í™•ì¥ ìƒê¶Œ' },
        { label: '1km', multiplier: 1.0, desc: 'ë„ë³´ 15ë¶„ ë‚´ì™¸ ì „ì²´ ì§„ë£Œê¶Œ' }
      ];

      let currentRadiusIndex = 2;

      // Chart
      let chartInstance = null;
      const ctx = document.getElementById('mainChart').getContext('2d');

      // Map & Heatmap
      let map = null;
      let isMapLoaded = false;
      // Default Coords (Gangnam) - ì‹¤ì œë¡œëŠ” ì£¼ì†Œ ê¸°ë°˜ì´ë‚˜, ì—¬ê¸°ì„œëŠ” ê³ ì •ê°’ ì‚¬ìš© (ë°ëª¨)
      // Kakao APIê°€ ì—†ìœ¼ë©´ ì—ëŸ¬ ë©”ì‹œì§€ë¥¼ ë„ìš°ëŠ” ë¡œì§ì€ ìœ ì§€
      const GANGNAM_COORDS = { lat: 37.517316, lng: 127.047466 }; 

      // -------------------------------------------------------
      // 2. Logic & Rendering
      // -------------------------------------------------------
      
      function initChart() {
        Chart.defaults.font.family = 'SUIT';
        Chart.defaults.color = '#666';

        chartInstance = new Chart(ctx, {
          type: 'bar',
          data: {
            labels: ['ì ì¬ í™˜ì', 'ì—¬ì„± ê³ ê°', '30ëŒ€ íƒ€ê²Ÿ'],
            datasets: [{
              label: 'ìœ ì € ìˆ˜',
              data: [0, 0, 0], // Initial empty
              backgroundColor: [
                'rgba(0, 0, 0, 0.8)',   // Black
                'rgba(100, 100, 100, 0.6)', // Gray
                'rgba(200, 200, 200, 0.4)'  // Light Gray
              ],
              borderWidth: 0,
              borderRadius: 4,
              barPercentage: 0.6
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: { display: false },
              tooltip: {
                backgroundColor: 'rgba(0,0,0,0.9)',
                padding: 12,
                cornerRadius: 4,
                titleFont: { family: 'SUIT' },
                bodyFont: { family: 'SUIT' }
              }
            },
            scales: {
              y: {
                beginAtZero: true,
                grid: { color: '#f0f0f0' },
                border: { display: false }
              },
              x: {
                grid: { display: false },
                border: { display: false }
              }
            },
            animation: { duration: 600, easing: 'easeOutQuart' }
          }
        });
      }

      function updateDashboard() {
        // 1. Calculate Multiplier
        const config = radiusConfig[currentRadiusIndex];
        const multiplier = config.multiplier;

        // 2. Compute Simulated Values
        const currentTotal = Math.round(baseTotal * multiplier);
        const currentGender = Math.round(baseGender * multiplier); 
        const currentAge = Math.round(baseAge * multiplier);       

        // 3. Update KPIs
        animateValue(elValScale, parseInt(elValScale.textContent.replace(/,/g, '') || 0), currentTotal, 500);
        
        // Percentages
        const precision = currentTotal > 0 ? ((currentAge / currentTotal) * 100).toFixed(1) : 0;
        elValPrecision.textContent = precision;

        const relevance = currentTotal > 0 ? ((currentGender / currentTotal) * 100).toFixed(1) : 0;
        elValRelevance.textContent = relevance;
        
        // Update Alerts
        if(elAlertTargetCount) elAlertTargetCount.textContent = currentTotal.toLocaleString();
        if(elStickyTargetCount) elStickyTargetCount.textContent = currentTotal.toLocaleString();

        // 4. Update Slider Feedback
        elRadiusDisplay.textContent = config.label;
        document.querySelector('.radius-context').textContent = config.desc;

        // 5. Update Chart
        if (chartInstance) {
          chartInstance.data.datasets[0].data = [currentTotal, currentGender, currentAge];
          chartInstance.update();
        }

        // 6. Update Map (if loaded)
        if (map) {
          updateHeatmapLevel(currentRadiusIndex);
        }
      }

      function animateValue(obj, start, end, duration) {
        if (!obj) return;
        let startTimestamp = null;
        const step = (timestamp) => {
          if (!startTimestamp) startTimestamp = timestamp;
          const progress = Math.min((timestamp - startTimestamp) / duration, 1);
          const value = Math.floor(progress * (end - start) + start);
          obj.textContent = value.toLocaleString();
          if (progress < 1) {
            window.requestAnimationFrame(step);
          }
        };
        window.requestAnimationFrame(step);
      }

      // -------------------------------------------------------
      // 3. Map Implementation
      // -------------------------------------------------------
      function loadKakaoMap() {
        // Kakao Map Key Check
        if (typeof TOUCH_CONFIG === 'undefined' || !TOUCH_CONFIG.KAKAO_API_KEY) {
          showMapError("ì§€ë„ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
          return;
        }

        const script = document.createElement("script");
        script.src = `https://dapi.kakao.com/v2/maps/sdk.js?appkey=${TOUCH_CONFIG.KAKAO_API_KEY}&libraries=services&autoload=false`;
        
        script.onload = () => {
          kakao.maps.load(() => {
            initMap();
          });
        };
        
        script.onerror = () => {
          showMapError("ì§€ë„ ì—°ê²°ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
        };

        document.head.appendChild(script);
      }

      function showMapError(msg) {
        const container = document.getElementById('kakaoMap');
        if (container) {
          container.innerHTML = `
            <div style="display:flex; flex-direction:column; justify-content:center; align-items:center; height:100%; background:#f5f5f5; color:#999; text-align:center;">
              <div style="font-size:24px; margin-bottom:10px;">âš ï¸</div>
              <div style="font-size:14px; font-weight:500;">${msg}</div>
            </div>
          `;
        }
      }

      function initMap() {
        const container = document.getElementById('kakaoMap');
        const options = {
          center: new kakao.maps.LatLng(GANGNAM_COORDS.lat, GANGNAM_COORDS.lng),
          level: 4
        };

        map = new kakao.maps.Map(container, options);
        isMapLoaded = true;

        // Geocoder for Address Search if stored address exists
        const storedAddress = localStorage.getItem('address-base');
        
        if (storedAddress) {
          const geocoder = new kakao.maps.services.Geocoder();
          geocoder.addressSearch(storedAddress, function(result, status) {
            if (status === kakao.maps.services.Status.OK) {
              const coords = new kakao.maps.LatLng(result[0].y, result[0].x);
              map.setCenter(coords);
              
              // Marker with custom style (if possible) or default
              new kakao.maps.Marker({
                map: map,
                position: coords
              });
              
              // Add Circle to visualize radius (Optional)
              // ...
            }
          });
        } else {
             // Default Market
             new kakao.maps.Marker({
                map: map,
                position: new kakao.maps.LatLng(GANGNAM_COORDS.lat, GANGNAM_COORDS.lng)
              });
        }
      }

      function updateHeatmapLevel(radiusIdx) {
        if (!map) return;
        const zoomLevels = [3, 4, 5]; 
        const targetLevel = zoomLevels[radiusIdx];
        map.setLevel(targetLevel, {animate: true});
      }

      // -------------------------------------------------------
      // 4. Interaction Wiring
      // -------------------------------------------------------
      
      initChart();
      updateDashboard();
      
      // Load Map slightly delayed to ensure DOM
      setTimeout(loadKakaoMap, 100);

      // Slider
      elRadiusSlider?.addEventListener('input', (e) => {
        currentRadiusIndex = parseInt(e.target.value);
        updateDashboard();
      });

    });
  </script>
</body>
</html>
